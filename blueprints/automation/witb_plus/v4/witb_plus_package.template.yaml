# WITB+ package template (v4.0.3)
# Tokens:
#   - room_slug          -> e.g., master_bedroom
#   - Room Friendly Name -> e.g., Master Bedroom

# --- HELPERS ---
input_boolean:
  room_slug_occupied:
    name: "Room Friendly Name Occupied"
    icon: mdi:account
    
  room_slug_automation_override:
    name: "Room Friendly Name Automation Override"
    icon: mdi:toggle-switch-off-outline

  room_slug_force_occupied:
    name: "Room Friendly Name Force Occupied"
    icon: mdi:lock

  room_slug_manual_occupied:
    name: "Room Friendly Name Manual Occupied"
    icon: mdi:hand

  room_slug_latched:
    name: "Room Friendly Name Latched"
    icon: mdi:door-closed-lock

input_number:
  # Adjusted to Minutes to match Blueprint logic
  room_slug_failsafe_timeout:
    name: "Room Friendly Name Failsafe Timeout"
    min: 5
    max: 1440
    step: 5
    unit_of_measurement: "min"
    icon: mdi:clock
    initial: 180
    mode: box

  room_slug_entry_window_seconds:
    name: "Room Friendly Name Entry Window Seconds"
    min: 1
    max: 60
    step: 1
    unit_of_measurement: "seconds"
    icon: mdi:timer-sand
    initial: 15
    mode: box

input_datetime:
  room_slug_last_motion:
    name: "Room Friendly Name Last Motion"
    has_date: true
    has_time: true

  room_slug_last_door:
    name: "Room Friendly Name Last Door"
    has_date: true
    has_time: true

  room_slug_last_exit_door:
    name: "Room Friendly Name Last Exit Door"
    has_date: true
    has_time: true

# --- TIMER ---
timer:
  room_slug_failsafe:
    name: "Room Friendly Name Failsafe"
    # Duration is dynamically set by the automation; this is just a fallback
    duration: "03:00:00"
    restore: true

# --- TEMPLATE SENSORS ---
template:
  - binary_sensor:
      - name: "Room Friendly Name Occupied Effective"
        unique_id: room_slug_occupied_effective
        device_class: occupancy
        state: >
          {{ is_state('input_boolean.room_slug_occupied','on')
             or is_state('input_boolean.room_slug_force_occupied','on')
             or is_state('input_boolean.room_slug_manual_occupied','on') }}

      - name: "Room Friendly Name WITB Override Active"
        unique_id: room_slug_witb_override_active
        state: >
          {{ is_state('input_boolean.room_slug_automation_override','on')
             or is_state('input_boolean.room_slug_force_occupied','on')
             or is_state('input_boolean.room_slug_manual_occupied','on') }}
        icon: mdi:shield-check

  - sensor:
      - name: "Room Friendly Name Minutes Since Motion"
        unique_id: room_slug_minutes_since_motion
        unit_of_measurement: "min"
        state: >
          {% set v = states('input_datetime.room_slug_last_motion') %}
          {% if v in ['unknown','unavailable','none',''] %}
            999999
          {% else %}
            {{ ((as_timestamp(now()) - as_timestamp(v)) / 60) | int }}
          {% endif %}