---
garage_witb:
  # WITB+ Core Package Template
  # Tokens: garage, Garage
  #
  # This template covers ONLY the helpers consumed by the WITB+ v4.2 occupancy
  # blueprint. It does NOT include lights/fan/lux/humidity/night helpers —
  # those live in the separate room_witb_actions_package_template.yaml.
  #
  # Feature blocks (controlled by --no-X flags or per-room `no_X: true` in config):
  #   helpers      - required core: occupancy (input_boolean) + last_motion,
  #                  last_door (input_datetime) + exit_eval (timer) +
  #                  occupied_effective binary_sensor (the glue consumed by
  #                  the WITB+ Actions blueprint as its trigger sensor)
  #   controls     - optional: automation_override, force_occupied, manual_occupied (input_boolean)
  #   latched      - optional: latched debug helper (input_boolean)
  #   exit_close   - optional: last_exit_door (input_datetime) for "door closes
  #                  behind you" rooms (bedroom/garage style)
  #   failsafe     - optional: failsafe timer + failsafe_timeout input_number
  #   entry_gating - optional: entry_window_seconds input_number

  input_boolean:
    # input_boolean restores last known state from recorder on restart.

    garage_occupied:
      name: "Garage occupied"
      icon: mdi:home-account

    garage_automation_override:
      name: "Garage automation override"
      icon: mdi:hand-back-right-outline

    garage_force_occupied:
      name: "Garage force occupied"
      icon: mdi:account-lock

    garage_manual_occupied:
      name: "Garage manual occupied"
      icon: mdi:account-edit

    garage_latched:
      name: "Garage latched"
      icon: mdi:door-closed-lock

  input_datetime:
    # input_datetime restores last value from recorder on restart.

    garage_last_motion:
      name: "Garage last motion"
      icon: mdi:motion-sensor
      has_date: true
      has_time: true

    garage_last_door:
      name: "Garage last door"
      icon: mdi:door
      has_date: true
      has_time: true

    garage_last_exit_door:
      name: "Garage last exit door"
      icon: mdi:door-open
      has_date: true
      has_time: true

  input_number:
    # input_number restores last value from recorder on restart.
    # Do NOT set `initial` — it resets the value on every HA restart.

    garage_failsafe_timeout:
      name: "Garage failsafe timeout (min)"
      icon: mdi:timer-alert-outline
      unit_of_measurement: "min"
      min: 5
      max: 5940
      step: 5
      mode: box

    garage_entry_window_seconds:
      name: "Garage entry window (sec)"
      icon: mdi:door-closed
      unit_of_measurement: "s"
      min: 1
      max: 60
      step: 1
      mode: box

  timer:
    # Required by WITB+ v4.2. Drives the non-blocking door-open exit path.
    # When a door opens while occupied, this timer starts for exit_timeout_seconds.
    # Motion returning cancels it. When it fires, the automation re-evaluates
    # whether to clear occupancy. Use no_helpers: true to exclude entirely,
    # or no_exit_eval: true if you need the other helpers but not this timer.
    garage_exit_eval:
      name: "Garage exit eval"
      icon: mdi:door-open
      restore: true

    garage_failsafe:
      name: "Garage failsafe"
      icon: mdi:timer-alert-outline
      duration: "03:00:00"
      restore: true

  # Modern 'template' integration syntax (Fixes legacy warning)
  template:
    - binary_sensor:
        # Raw occupancy — mirrors input_boolean.garage_occupied directly.
        - name: "Garage Occupied"
          unique_id: "garage_occupied_sensor"
          device_class: occupancy
          state: >-
            {{ is_state('input_boolean.garage_occupied', 'on') }}

        # Effective occupancy — consumed by the WITB+ Actions blueprint.
        # ON when occupied OR force_occupied OR manual_occupied.
        - name: "Garage Occupied Effective"
          unique_id: "garage_occupied_effective"
          device_class: occupancy
          state: >-
            {{ is_state('input_boolean.garage_occupied', 'on')
               or is_state('input_boolean.garage_force_occupied', 'on')
               or is_state('input_boolean.garage_manual_occupied', 'on') }}

        - name: "Room Friendly WITB Override Active"
          unique_id: "garage_witb_override_active"
          icon: mdi:hand-back-right-outline
          state: >-
            {{ is_state('input_boolean.garage_automation_override', 'on')
              or is_state('input_boolean.garage_force_occupied', 'on') }}
