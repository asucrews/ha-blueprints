blueprint:
  homeassistant:
    min_version: 2026.2.0
  domain: automation
  source_url: https://github.com/asucrews/ha-blueprints/blob/main/blueprints/automation/witb_plus/v4/witb_plus.yaml
  name: WITB+ v4.2.4
  description: |
    Version: 4.2.4 — see CHANGELOG.md for full version history.

    Occupancy inference for a single room using doors, PIR motion, and optional
    mmWave presence. Drives an input_boolean occupancy helper that downstream
    automations (e.g. WITB+ Actions) react to.

    OCCUPANCY ASSERTION
      • PIR motion ON → room asserts occupied.
      • Optional mmWave ON → can assert occupied (disabled by default; only enable
        if your sensor has clean room isolation).
      • Force Occupied ON → pins occupancy ON, blocks all clearing paths.
        Supports multiple helpers — any one ON is sufficient to pin the room.
      • Manual Occupied ON → asserts occupied but still allows exit-based clearing.
        Supports multiple helpers — useful for bedrooms with adjoining bathroom,
        hallway, or closet where occupancy in any connected room should keep the
        parent room occupied.

    OCCUPANCY CLEARING
      • Transition door OPEN + motion off for exit_timeout_seconds → starts exit
        evaluation timer. When timer fires, clears if conditions still hold.
        Motion returning before the timer fires cancels it immediately.
      • Seal door CLOSED → blocks all clearing (protects sleeping/still occupants).
        Failsafe restarts instead of clearing when sealed.
        NOTE: exit_recent (door-closes-behind-you) does NOT override the seal door
        guard. A closed seal door always blocks clearing — period.
      • mmWave ON → blocks clearing while ON (recommended mode).
      • "Door closes behind you" path (optional): supports bedroom/garage-style
        exits where the door closes after you leave. Only valid when seal door is
        OPEN at time of clear evaluation.

    FAILSAFE
      • Long-running timer prevents permanently stuck occupied states.
      • Safe: never clears while seal door is closed — restarts instead.
      • Hard deadlock break: clears if motion has been off for 1.5× the failsafe
        duration AND force_occupied is OFF.

    ENTRY GATING (optional)
      • Prevents walk-by false positives on open-door sightlines.
      • Motion only asserts if a door event occurred within entry_window_seconds,
        or the seal door is currently closed, or the room is already occupied.

    CONTROLS (priority order)
      1. Automation Override ON → automation does nothing (full manual handoff).
      2. Force Occupied ON → pins ON, blocks all clearing including deadlock break.
         Multiple entities supported — any one ON is sufficient.
      3. Manual Occupied ON → asserts ON, allows normal exit-based clearing.
         Multiple entities supported — any one ON is sufficient.

    REQUIRED HELPERS (create one set per room)
      • input_boolean  — occupancy_helper
      • input_datetime — last_motion_helper
      • input_datetime — last_door_helper
      • timer          — exit_eval_timer

  input:
    doors_and_motion:
      name: Doors & Motion (required)
      icon: mdi:door
      description: >
        Required sensors for the room:
          - seal_door: main/privacy door used for "sealed" semantics
          - transition_doors: door(s) representing boundary crossings
          - motion_sensor: PIR that asserts occupancy
      input:
        seal_door:
          name: Seal Door (main/privacy door)
          description: >
            The room's MAIN door used for "sealed" semantics (failsafe / still-occupant protection).
            Sealed means this door is CLOSED. This door does NOT have to be the only transition door.
          selector:
            entity:
              domain: binary_sensor
              device_class: door

        transition_doors:
          name: Transition Doors (1+)
          description: >
            Doors that represent leaving/entering this room's zone (movement/transition semantics).
            Select one or more. Include the seal door here if it is also a transition door.
          selector:
            entity:
              domain: binary_sensor
              device_class: door
              multiple: true

        motion_sensor:
          name: Motion Sensor (PIR)
          selector:
            entity:
              domain: binary_sensor
              device_class: motion

    mmwave:
      name: mmWave (optional)
      icon: mdi:radar
      collapsed: true
      description: >
        Optional presence/occupancy sensor (e.g., mmWave). Recommended usage:
          - blocks clearing while ON (mmwave_blocks_clear: true)
          - only allow asserting occupancy if you trust its room isolation
      input:
        mmwave_sensor:
          name: mmWave Presence Sensor (optional)
          description: >
            Optional presence/occupancy binary_sensor (e.g., mmWave).
            When configured, it can block clearing while ON (recommended), and can optionally
            assert occupancy when ON (if enabled below).
          default: []
          selector:
            entity:
              domain: binary_sensor

        mmwave_blocks_clear:
          name: mmWave blocks clearing while ON
          description: >
            If enabled and mmWave is configured, occupancy will not clear while mmWave is ON.
          default: true
          selector:
            boolean: {}

        mmwave_asserts_occupied:
          name: Allow mmWave to assert occupancy
          description: >
            If enabled and mmWave is configured, mmWave ON can assert occupied ON (subject to entry gating if enabled).
            Leave disabled if your mmWave can see through walls or adjacent rooms.
          default: false
          selector:
            boolean: {}

    helpers_required:
      name: Helpers (required)
      icon: mdi:form-textbox
      description: >
        Required helpers per room. These are typically created in your per-room package.
      input:
        occupancy_helper:
          name: Occupancy Helper (input_boolean)
          selector:
            entity:
              domain: input_boolean

        last_motion_helper:
          name: Last Motion Helper (input_datetime)
          description: Stores timestamp of last motion ON.
          selector:
            entity:
              domain: input_datetime

        last_door_helper:
          name: Last Door Helper (input_datetime)
          description: Stores timestamp of last door state change.
          selector:
            entity:
              domain: input_datetime

    exit_evaluation:
      name: Exit Evaluation Timer (required for door-open path)
      icon: mdi:timer-play-outline
      description: >
        A dedicated timer that drives the door-open exit evaluation.
        When a door opens while occupied, this timer starts for exit_timeout_seconds.
        If motion returns before the timer finishes, the timer is cancelled immediately.
        When the timer fires, the automation re-checks sensor state and clears if safe.
        Create one timer per room (e.g. timer.bedroom_exit_eval). Recommended duration
        is set dynamically from exit_timeout_seconds — no manual duration needed on the
        helper itself.
      input:
        exit_eval_timer:
          name: Exit Evaluation Timer
          description: >
            Timer used to drive the non-blocking door-open exit evaluation path.
            Create one per room: timer.ROOM_exit_eval
          selector:
            entity:
              domain: timer

    exit_close_after_exit:
      name: Door closes behind you (optional)
      icon: mdi:door-closed
      collapsed: true
      description: >
        Optional helper + window to support rooms where you can leave and then the door closes behind you
        (bedroom/garage style): open -> close -> motion stops still counts as exit for a short window.
        NOTE: exit_recent only permits clearing when the seal door is OPEN. A closed seal door
        always blocks clearing regardless of exit_recent — this protects sleeping/still occupants
        from being disturbed when a second person leaves the room.
      input:
        last_exit_door_helper:
          name: Last Exit Door Helper (optional, input_datetime)
          description: >
            Optional helper used to support "door can close after leaving" rooms.
            This stores the timestamp when a transition/seal door OPENED while the room was already occupied.
            If set, the automation can clear occupancy after the door closes behind you (garage/bedroom style).
          default: []
          selector:
            entity:
              domain: input_datetime

        exit_recent_window_seconds:
          name: Exit-Close Window (seconds)
          description: >
            How long after a door OPENED while occupied we still treat exit as possible, even if the door is now closed.
            Must be >= Exit Timeout to cover "open -> close -> motion stops" sequences.
          default: 180
          selector:
            number:
              min: 30
              max: 900
              unit_of_measurement: seconds
              mode: slider

        exit_mark_requires_recent_motion:
          name: Only mark possible-exit when motion is recent
          description: >
            Prevents "someone opened the door while I'm asleep" from creating an exit_recent window.
            When enabled, WITB only records last_exit_door_helper when a door opens while occupied AND
            motion is currently ON or motion was detected within the window below.
          default: true
          selector:
            boolean: {}

        exit_mark_motion_window_seconds:
          name: Exit mark motion window (seconds)
          description: >
            Maximum age of the last motion ON event to count as "recent" for marking a possible exit.
            Smaller = safer (less false clears), larger = more tolerant if your PIR misses doorway motion.
          default: 45
          selector:
            number:
              min: 5
              max: 300
              unit_of_measurement: seconds
              mode: slider

    latched_debug:
      name: Latch helper (optional)
      icon: mdi:door-closed-lock
      collapsed: true
      description: >
        Optional debug/helper: latched is ON when the seal door is closed while occupied.
      input:
        latched_helper:
          name: Latched Helper (optional, input_boolean)
          description: >
            Optional debug/helper: ON when the SEAL door is closed while occupied.
            OFF when the SEAL door opens or occupancy clears.
          default: []
          selector:
            entity:
              domain: input_boolean

    clearing_and_timeouts:
      name: Clearing & Timeouts
      icon: mdi:timer-outline
      description: >
        Exit timeout controls how long we wait after motion stops to clear (when exit is possible).
      input:
        exit_timeout_seconds:
          name: Exit Timeout (seconds)
          description: >
            When occupied and door is OPEN, if no motion for this long -> clear occupancy.
            This value is also used as the duration for the Exit Evaluation Timer.
          default: 60
          selector:
            number:
              min: 5
              max: 600
              unit_of_measurement: seconds
              mode: slider

    controls:
      name: Controls (optional)
      icon: mdi:shield
      collapsed: true
      description: >
        Optional per-room control helpers.
        If you do not use these, leave them empty and do not wire them in the automation instance.
      input:
        automation_override:
          name: Automation Override (optional)
          description: If ON, this automation does nothing (hands off).
          default: []
          selector:
            entity:
              domain: input_boolean

        force_occupied:
          name: Force Occupied (optional)
          description: >
            If ON, pins occupancy ON and blocks clearing. Supports multiple helpers —
            useful when multiple physical switches or virtual helpers (e.g. a wall switch
            AND a guest mode boolean) should each independently be able to force the room
            occupied. Any one ON is sufficient to pin.
          default: []
          selector:
            entity:
              domain: input_boolean
              multiple: true

        manual_occupied:
          name: Manual Occupied (optional)
          description: >
            If ON, asserts occupancy ON but still allows normal exit-based clearing.
            Supports multiple helpers — useful for rooms with adjoining spaces (e.g. bedroom
            with an ensuite bathroom, hallway, or closet). Occupancy is asserted if ANY
            of the selected helpers are ON.
          default: []
          selector:
            entity:
              domain: input_boolean
              multiple: true

    entry_gating:
      name: Entry gating (optional)
      icon: mdi:walk
      collapsed: true
      description: >
        Prevents "walk-by" false positives in open-door sightlines.
        When enabled, motion asserts occupancy only if a door event occurred recently
        (or the seal door is closed, or occupancy is already on).
      input:
        require_door_for_entry:
          name: Require recent door event for entry
          description: >
            If enabled, motion will assert occupancy only if a door event occurred within entry_window_seconds,
            OR the door is currently CLOSED, OR occupancy is already ON.
          default: false
          selector:
            boolean: {}

        entry_window_seconds:
          name: Entry window (seconds)
          description: >
            How recent a door change must be to accept motion as an entry when gating is enabled.
            Used only if the Helper below is not defined.
          default: 15
          selector:
            number:
              min: 1
              max: 60
              unit_of_measurement: seconds
              mode: slider

    failsafe:
      name: Failsafe (optional)
      icon: mdi:timer-alert-outline
      collapsed: true
      description: >
        SAFE failsafe timer (no polling):
          - When timer finishes, clear ONLY if seal door is OPEN (or exit_recent) and motion is OFF.
          - If seal door is CLOSED, do NOT clear; restart timer instead.
      input:
        enable_failsafe:
          name: Enable failsafe timer
          description: >
            If enabled, uses a timer to prevent permanently stuck occupied states.
            SAFE behavior: failsafe will never clear while door is CLOSED.
            NOTE: If 'Failsafe Timeout Helper' is assigned, it OVERRIDES the slider below.
          default: true
          selector:
            boolean: {}

        failsafe_timer:
          name: Failsafe Timer (required if failsafe is enabled)
          description: Create one per room (e.g., timer.toilet_failsafe). Only used when failsafe is enabled.
          default: []
          selector:
            entity:
              domain: timer

        failsafe_minutes:
          name: Failsafe duration (minutes)
          description: >
            Duration loaded into the failsafe timer whenever occupancy is asserted/renewed.
            Toilet suggestion: 90-180. Bedroom suggestion: 720-1440 (max 5940 / 99h).
            Used only if the Failsafe Timeout Helper below is not defined.
          default: 180
          selector:
            number:
              min: 5
              max: 5940
              unit_of_measurement: minutes
              mode: slider

        failsafe_timeout_helper:
          name: Failsafe Timeout Helper (optional)
          description: >
            Link to input_number.room_slug_failsafe_timeout.
            When set, this overrides the failsafe_minutes slider above.
          default: []
          selector:
            entity:
              domain: input_number

        entry_window_helper:
          name: Entry Window Helper (optional)
          description: >
            Link to input_number.room_slug_entry_window_seconds.
            When set, this overrides the entry_window_seconds slider above.
          default: []
          selector:
            entity:
              domain: input_number

# FIX #2: mode: restart is correct here because ALL runs are now non-blocking.
# The exit evaluation delay is handled by the exit_eval_timer — the automation
# run that starts the timer completes in milliseconds. When the timer fires, a
# new fast run evaluates whether to clear. No run ever sleeps, so restart is
# safe and desirable (prevents stale queued runs from piling up).
mode: restart
max_exceeded: silent

variables:
  seal: !input seal_door
  doors: !input transition_doors
  motion: !input motion_sensor
  mm: !input mmwave_sensor
  mm_block: !input mmwave_blocks_clear
  mm_assert: !input mmwave_asserts_occupied
  mm_enabled: "{{ mm is string and mm|length > 0 }}"
  mm_on: "{{ mm_enabled and is_state(mm, 'on') }}"
  mm_clear_ok: "{{ (not mm_enabled) or (not mm_block) or is_state(mm, 'off') }}"
  occ: !input occupancy_helper
  last_motion: !input last_motion_helper
  last_door: !input last_door_helper
  latch: !input latched_helper

  # FIX #2: Exit evaluation timer (replaces wait_template blocking delay)
  exit_eval_tmr: !input exit_eval_timer
  exit_s: !input exit_timeout_seconds
  # Duration string for the exit eval timer (always seconds-based, simple format)
  exit_eval_duration: "{{ '00:00:' ~ '%02d' | format(exit_s | int) }}"

  # Controls
  ov: !input automation_override
  force: !input force_occupied
  manual: !input manual_occupied

  # Entry gating
  entry_window_input: !input entry_window_helper
  require_door: !input require_door_for_entry
  entry_s: "{{ states(entry_window_input) | int(15) }}"

  # Failsafe
  failsafe_timeout_input: !input failsafe_timeout_helper
  enable_fs: !input enable_failsafe
  fs_timer: !input failsafe_timer
  fs_min: "{{ states(failsafe_timeout_input) | int(180) }}"

  # Door semantics
  sealed_now: "{{ is_state(seal, 'off') }}"
  any_transition_open: >-
    {% set ds = doors if doors is not string else [doors] %}
    {% set ns = namespace(open=false) %}
    {% for d in ds %}
      {% if is_state(d, 'on') %}
        {% set ns.open = true %}
      {% endif %}
    {% endfor %}
    {{ ns.open }}

  # Helpers
  latch_enabled: "{{ latch is string and latch|length > 0 }}"
  ov_on: >-
    {% if ov is string and ov|length > 0 %}
      {{ is_state(ov, 'on') }}
    {% else %}
      false
    {% endif %}
  # v4.2.3: force_occupied now supports multiple helpers (list or single string).
  # Any one of the selected helpers being ON is sufficient to pin occupancy ON
  # and block all clearing paths including the deadlock break.
  force_on: >-
    {% if force is string and force|length > 0 %}
      {{ is_state(force, 'on') }}
    {% elif force is iterable and force|length > 0 %}
      {% set ns = namespace(any_on=false) %}
      {% for f in force %}
        {% if is_state(f, 'on') %}
          {% set ns.any_on = true %}
        {% endif %}
      {% endfor %}
      {{ ns.any_on }}
    {% else %}
      false
    {% endif %}

  # v4.2.2: manual_occupied now supports multiple helpers (list or single string).
  # Any one of the selected helpers being ON is sufficient to assert occupancy.
  # Typical use: wire adjoining room occupancy helpers here so a bedroom stays
  # occupied while someone is in the ensuite bathroom, hallway, or closet.
  manual_on: >-
    {% if manual is string and manual|length > 0 %}
      {{ is_state(manual, 'on') }}
    {% elif manual is iterable and manual|length > 0 %}
      {% set ns = namespace(any_on=false) %}
      {% for m in manual %}
        {% if is_state(m, 'on') %}
          {% set ns.any_on = true %}
        {% endif %}
      {% endfor %}
      {{ ns.any_on }}
    {% else %}
      false
    {% endif %}

  # FIX #8: Cap hours at 99 to prevent invalid timer strings (e.g. "100:00:00").
  # Slider max of 5940 minutes (99h) makes this a safety net only.
  fs_duration_hms: >-
    {% set m = fs_min | int %}
    {% set h = [m // 60, 99] | min %}
    {% set mm = (m % 60) %}
    {{ '%02d:%02d:00' | format(h, mm) }}

  # FIX #10: Removed | int from now().timestamp() to preserve sub-second precision.
  # This matters for short entry windows (e.g. 5–15 s).
  last_door_ts: >-
    {% set v = states(last_door) %}
    {% if v in ['unknown','unavailable','none',''] %}
      0
    {% else %}
      {{ as_timestamp(v) | float(0) }}
    {% endif %}
  seconds_since_door: "{{ now().timestamp() - last_door_ts }}"

  last_motion_ts: >-
    {% set v = states(last_motion) %}
    {% if v in ['unknown','unavailable','none',''] %}
      0
    {% else %}
      {{ as_timestamp(v) | float(0) }}
    {% endif %}
  seconds_since_motion: "{{ now().timestamp() - last_motion_ts }}"

  # "Door can close after leaving" helpers
  last_exit: !input last_exit_door_helper
  exit_win_s: !input exit_recent_window_seconds
  exit_mark_require_motion: !input exit_mark_requires_recent_motion
  exit_mark_motion_s: !input exit_mark_motion_window_seconds
  exit_enabled: "{{ last_exit is string and last_exit|length > 0 }}"
  last_exit_ts: >-
    {% if exit_enabled %}
      {% set v = states(last_exit) %}
      {% if v in ['unknown','unavailable','none',''] %}
        0
      {% else %}
        {{ as_timestamp(v) | float(0) }}
      {% endif %}
    {% else %}
      0
    {% endif %}
  seconds_since_exit: "{{ now().timestamp() - last_exit_ts }}"
  exit_recent: "{{ exit_enabled and (seconds_since_exit | float) <= (exit_win_s | int) }}"

trigger:
  # ---- Presence signals ----
  - id: motion_on
    platform: state
    entity_id: !input motion_sensor
    to: "on"

  # FIX #6: Use platform: state for mmWave — template triggers without a watched
  # entity_id are unreliable and can miss transitions.
  - id: mmwave_on
    platform: state
    entity_id: !input mmwave_sensor
    to: "on"

  - id: mmwave_off_for
    platform: state
    entity_id: !input mmwave_sensor
    to: "off"
    for:
      seconds: !input exit_timeout_seconds

  # ---- Door signals ----
  # FIX #1: transition_open and seal_open removed. Door-open logic is handled
  # inside the transition_change / seal_change blocks by checking
  # trigger.to_state.state == 'on', eliminating the double-fire race.
  - id: transition_change
    platform: state
    entity_id: !input transition_doors

  - id: seal_change
    platform: state
    entity_id: !input seal_door

  # ---- Timeout-based clear path (motion off for N seconds) ----
  - id: motion_off_for
    platform: state
    entity_id: !input motion_sensor
    to: "off"
    for:
      seconds: !input exit_timeout_seconds

  # ---- FIX #2: Exit eval timer completion ----
  # Fires when the exit_eval_timer finishes. At that point we re-check all
  # sensor states and clear occupancy if the exit conditions are still met.
  - id: exit_eval_done
    platform: event
    event_type: timer.finished
    event_data:
      entity_id: !input exit_eval_timer

  # ---- Control triggers ----
  # FIX #7: HA 2024.4+ silently ignores state triggers on empty [] entity lists.
  - id: override_off
    platform: state
    entity_id: !input automation_override
    to: "off"

  # v4.2.3: force_occupied now supports multiple entities. HA automatically
  # watches all entities in the list when a list is passed to entity_id.
  - id: force_on
    platform: state
    entity_id: !input force_occupied
    to: "on"

  - id: force_off
    platform: state
    entity_id: !input force_occupied
    to: "off"

  # v4.2.2: manual_occupied now supports multiple entities. HA automatically
  # watches all entities in the list when a list is passed to entity_id.
  - id: manual_on
    platform: state
    entity_id: !input manual_occupied
    to: "on"

  - id: manual_off
    platform: state
    entity_id: !input manual_occupied
    to: "off"

  # ---- Failsafe timer completion ----
  - id: failsafe_done
    platform: event
    event_type: timer.finished
    event_data:
      entity_id: !input failsafe_timer

# If override is ON, do nothing at all
condition:
  - condition: template
    value_template: "{{ not ov_on }}"

action:
  # ---------------------------------------------------------------------------
  # 1. LATCH SYNC: Keep latch helper in sync with door + occupancy state.
  # FIX #5: Only runs on door/seal/motion triggers. Previously ran on every
  # trigger (including failsafe_done and override_off), causing spurious state
  # churn on the latch helper.
  # ---------------------------------------------------------------------------
  - choose:
      - conditions:
          - condition: template
            value_template: >-
              {{ trigger.id in ['transition_change','seal_change','motion_on','motion_off_for'] }}
          - condition: template
            value_template: "{{ latch_enabled }}"
        sequence:
          - action: >-
              input_boolean.{{ 'turn_on' if is_state(seal, 'off') and is_state(occ, 'on') else 'turn_off' }}
            target:
              entity_id: !input latched_helper
    default: []

  # ---------------------------------------------------------------------------
  # 1b) Keep last_door updated on any door change (entry gating + debugging)
  # ---------------------------------------------------------------------------
  - choose:
      - conditions:
          - condition: template
            value_template: "{{ trigger.id in ['transition_change','seal_change'] }}"
        sequence:
          - action: input_datetime.set_datetime
            target:
              entity_id: "{{ last_door }}"
            data:
              timestamp: "{{ now().timestamp() }}"
    default: []

  # ---------------------------------------------------------------------------
  # 1c) Mark a "possible exit" when a door OPENS while already occupied.
  # FIX #1: Uses trigger.to_state.state == 'on' instead of the removed
  # transition_open / seal_open trigger IDs.
  # ---------------------------------------------------------------------------
  - choose:
      - conditions:
          - condition: template
            value_template: >-
              {{ trigger.id in ['transition_change','seal_change']
                 and trigger.to_state.state == 'on'
                 and exit_enabled }}
          - condition: state
            entity_id: !input occupancy_helper
            state: "on"
          - condition: template
            value_template: >-
              {{ (not exit_mark_require_motion)
                  or is_state(motion, 'on')
                  or ((seconds_since_motion | float(999999)) <= (exit_mark_motion_s | int(0))) }}
        sequence:
          - action: input_datetime.set_datetime
            target:
              entity_id: "{{ last_exit }}"
            data:
              timestamp: "{{ now().timestamp() }}"
    default: []

  # ---------------------------------------------------------------------------
  # 2) Force Occupied: pin ON and block all clearing
  # ---------------------------------------------------------------------------
  - choose:
      - conditions:
          - condition: template
            value_template: "{{ force_on }}"
        sequence:
          - action: input_boolean.turn_on
            target:
              entity_id: "{{ occ }}"
          - action: input_datetime.set_datetime
            target:
              entity_id: "{{ last_motion }}"
            data:
              timestamp: "{{ now().timestamp() }}"
          - choose:
              - conditions:
                  - condition: template
                    value_template: "{{ latch_enabled and is_state(seal, 'off') }}"
                sequence:
                  - action: input_boolean.turn_on
                    target:
                      entity_id: "{{ latch }}"
            default: []
          - choose:
              - conditions:
                  - condition: template
                    value_template: "{{ enable_fs and (fs_timer is string) and (fs_timer|length > 0) }}"
                sequence:
                  - action: timer.start
                    target:
                      entity_id: "{{ fs_timer }}"
                    data:
                      duration: "{{ fs_duration_hms }}"
            default: []
          # Cancel any pending exit evaluation — force overrides it
          - action: timer.cancel
            target:
              entity_id: "{{ exit_eval_tmr }}"
          - stop: "Force occupied active"
    default: []

  # ---------------------------------------------------------------------------
  # 3) Manual Occupied: assert ON (soft); normal exit-based clearing still applies.
  #    v4.2.2: manual_on now true if ANY of the configured helpers is ON.
  # ---------------------------------------------------------------------------
  - choose:
      - conditions:
          - condition: template
            value_template: "{{ manual_on }}"
        sequence:
          - action: input_boolean.turn_on
            target:
              entity_id: "{{ occ }}"
          - action: input_datetime.set_datetime
            target:
              entity_id: "{{ last_motion }}"
            data:
              timestamp: "{{ now().timestamp() }}"
          - choose:
              - conditions:
                  - condition: template
                    value_template: "{{ latch_enabled and is_state(seal, 'off') }}"
                sequence:
                  - action: input_boolean.turn_on
                    target:
                      entity_id: "{{ latch }}"
            default: []
          - choose:
              - conditions:
                  - condition: template
                    value_template: "{{ enable_fs and (fs_timer is string) and (fs_timer|length > 0) }}"
                sequence:
                  - action: timer.start
                    target:
                      entity_id: "{{ fs_timer }}"
                    data:
                      duration: "{{ fs_duration_hms }}"
            default: []
    default: []

  # ---------------------------------------------------------------------------
  # 4) Motion ON: assert occupancy (with optional entry gating)
  #    Also cancel any running exit_eval_timer — motion means room is occupied.
  # ---------------------------------------------------------------------------
  - choose:
      - conditions:
          - condition: trigger
            id: motion_on
        sequence:
          - choose:
              - conditions:
                  - condition: template
                    value_template: >
                      {% if not require_door %}
                        true
                      {% else %}
                        {{ is_state(seal,'off') or (seconds_since_door <= (entry_s | int)) or is_state(occ,'on') }}
                      {% endif %}
                sequence:
                  - action: input_boolean.turn_on
                    target:
                      entity_id: "{{ occ }}"
                  - action: input_datetime.set_datetime
                    target:
                      entity_id: "{{ last_motion }}"
                    data:
                      timestamp: "{{ now().timestamp() }}"
                  - choose:
                      - conditions:
                          - condition: template
                            value_template: "{{ latch_enabled and is_state(seal,'off') }}"
                        sequence:
                          - action: input_boolean.turn_on
                            target:
                              entity_id: "{{ latch }}"
                    default: []
                  - choose:
                      - conditions:
                          - condition: template
                            value_template: "{{ enable_fs and (fs_timer is string) and (fs_timer|length > 0) }}"
                        sequence:
                          - action: timer.start
                            target:
                              entity_id: "{{ fs_timer }}"
                            data:
                              duration: "{{ fs_duration_hms }}"
                    default: []
                  # FIX #2: Motion returned — cancel any in-flight exit evaluation.
                  - action: timer.cancel
                    target:
                      entity_id: "{{ exit_eval_tmr }}"
            default: []
    default: []

  # ---------------------------------------------------------------------------
  # 4b) mmWave ON: refresh presence; optionally assert occupancy
  #     Also cancel any running exit_eval_timer.
  # ---------------------------------------------------------------------------
  - choose:
      - conditions:
          - condition: trigger
            id: mmwave_on
        sequence:
          # If allowed, mmWave can assert occupancy (subject to entry gating).
          - choose:
              - conditions:
                  - condition: template
                    value_template: "{{ mm_assert }}"
                sequence:
                  - choose:
                      - conditions:
                          - condition: template
                            value_template: >
                              {% if not require_door %}
                                true
                              {% else %}
                                {{ is_state(seal,'off') or (seconds_since_door <= (entry_s | int)) or is_state(occ,'on') }}
                              {% endif %}
                        sequence:
                          - action: input_boolean.turn_on
                            target:
                              entity_id: "{{ occ }}"
                    default: []
            default: []

          # Refresh timestamps and failsafe whenever occupied (including just after asserting).
          - choose:
              - conditions:
                  - condition: state
                    entity_id: !input occupancy_helper
                    state: "on"
                sequence:
                  - action: input_datetime.set_datetime
                    target:
                      entity_id: "{{ last_motion }}"
                    data:
                      timestamp: "{{ now().timestamp() }}"
                  - choose:
                      - conditions:
                          - condition: template
                            value_template: "{{ latch_enabled and is_state(seal,'off') }}"
                        sequence:
                          - action: input_boolean.turn_on
                            target:
                              entity_id: "{{ latch }}"
                    default: []
                  - choose:
                      - conditions:
                          - condition: template
                            value_template: "{{ enable_fs and (fs_timer is string) and (fs_timer|length > 0) }}"
                        sequence:
                          - action: timer.start
                            target:
                              entity_id: "{{ fs_timer }}"
                            data:
                              duration: "{{ fs_duration_hms }}"
                    default: []
                  # mmWave is on — cancel any in-flight exit evaluation.
                  - action: timer.cancel
                    target:
                      entity_id: "{{ exit_eval_tmr }}"
            default: []
    default: []

  # ---------------------------------------------------------------------------
  # 5) Door OPENS while occupied: start the exit evaluation timer.
  #
  # FIX #2 (core change): Instead of a blocking wait_template delay, we simply
  # start exit_eval_tmr for exit_timeout_seconds. The run completes immediately.
  # When the timer fires, block 5b re-checks all sensor state and clears if safe.
  # If motion returns before the timer fires, block 4 (motion_on) cancels it.
  #
  # Why this is better than wait_template:
  #   - The automation run is non-blocking (completes in ms, not 5-600s).
  #   - mode: restart is safe again — no stale delayed runs sitting in a queue.
  #   - timer.start on an already-running timer automatically restarts it, so
  #     a second door open while the timer is running extends/resets the window
  #     correctly without any special handling.
  #   - Motion cancelling the timer is explicit and immediate (timer.cancel in block 4).
  #
  # FIX #1: Checks trigger.to_state.state == 'on' (replaces removed transition_open /
  # seal_open trigger IDs).
  # ---------------------------------------------------------------------------
  - choose:
      - conditions:
          - condition: template
            value_template: >-
              {{ trigger.id in ['transition_change','seal_change']
                 and trigger.to_state.state == 'on' }}
          - condition: state
            entity_id: !input occupancy_helper
            state: "on"
        sequence:
          - action: timer.start
            target:
              entity_id: "{{ exit_eval_tmr }}"
            data:
              duration: "{{ exit_eval_duration }}"
    default: []

  # ---------------------------------------------------------------------------
  # 5b) Exit evaluation timer FINISHED: re-check state and clear if safe.
  #
  # FIX #2: This is the new event-driven evaluation that replaces the post-wait
  # conditions that previously lived in block 5.
  # FIX #3: All state variables are computed fresh here (not from stale top-level
  # variables frozen at the original trigger time). exit_recent_rt in particular
  # is recalculated so an expired exit window is never treated as still-recent.
  # FIX #11 (v4.2.4): exit_recent_rt no longer overrides the sealed door guard.
  # A closed seal door always blocks clearing. exit_recent only substitutes for
  # a currently-open transition door, not for the sealed-door protection.
  # ---------------------------------------------------------------------------
  - choose:
      - conditions:
          - condition: trigger
            id: exit_eval_done
        sequence:
          # Recompute all relevant state NOW (after the timer delay).
          - variables:
              sealed_now_rt: "{{ is_state(seal, 'off') }}"
              any_transition_open_rt: >-
                {% set ds = doors if doors is not string else [doors] %}
                {% set ns = namespace(open=false) %}
                {% for d in ds %}
                  {% if is_state(d, 'on') %}
                    {% set ns.open = true %}
                  {% endif %}
                {% endfor %}
                {{ ns.open }}
              mm_clear_ok_rt: "{{ (not mm_enabled) or (not mm_block) or is_state(mm, 'off') }}"
              # FIX #3: Recalculate exit_recent at runtime. The top-level exit_recent
              # was evaluated at trigger time and is stale by the time this fires.
              exit_recent_rt: >-
                {% if exit_enabled %}
                  {% set ts = states(last_exit) | as_timestamp(0) %}
                  {{ (now().timestamp() - ts) <= (exit_win_s | int) }}
                {% else %}
                  false
                {% endif %}
              # v4.2.3: Recompute force_on at runtime so a still-active force helper
              # blocks clearing even after the timer delay.
              force_on_rt: >-
                {% if force is string and force|length > 0 %}
                  {{ is_state(force, 'on') }}
                {% elif force is iterable and force|length > 0 %}
                  {% set ns = namespace(any_on=false) %}
                  {% for f in force %}
                    {% if is_state(f, 'on') %}
                      {% set ns.any_on = true %}
                    {% endif %}
                  {% endfor %}
                  {{ ns.any_on }}
                {% else %}
                  false
                {% endif %}
              # v4.2.2: Recompute manual_on at runtime so a still-active adjoining
              # room occupancy helper blocks clearing even after the timer delay.
              manual_on_rt: >-
                {% if manual is string and manual|length > 0 %}
                  {{ is_state(manual, 'on') }}
                {% elif manual is iterable and manual|length > 0 %}
                  {% set ns = namespace(any_on=false) %}
                  {% for m in manual %}
                    {% if is_state(m, 'on') %}
                      {% set ns.any_on = true %}
                    {% endif %}
                  {% endfor %}
                  {{ ns.any_on }}
                {% else %}
                  false
                {% endif %}

          - condition: state
            entity_id: !input occupancy_helper
            state: "on"
          # v4.2.3: Do not clear if any force_occupied helper is still ON.
          - condition: template
            value_template: "{{ not force_on_rt }}"
          # v4.2.2: Do not clear if any manual_occupied helper is still ON.
          - condition: template
            value_template: "{{ not manual_on_rt }}"
          # exit_recent can substitute for a currently-open door, but NOT for a closed seal door.
          - condition: template
            value_template: "{{ any_transition_open_rt or exit_recent_rt }}"
          # FIX #11 (v4.2.4): Seal door closed ALWAYS blocks clearing.
          # exit_recent must NOT override this — a sleeping occupant must be protected
          # even when a second person leaves and the door closes behind them.
          - condition: template
            value_template: "{{ not sealed_now_rt }}"
          - condition: template
            value_template: "{{ is_state(motion, 'off') }}"
          - condition: template
            value_template: "{{ mm_clear_ok_rt }}"
          - action: input_boolean.turn_off
            target:
              entity_id: "{{ occ }}"
          # FIX #3: Cancel fs_timer immediately after clearing occupancy.
          # With mode:restart, any new trigger arriving between here and the old
          # position at the end of the sequence would kill this run before the
          # cancel executed, leaving the failsafe timer orphaned and running.
          - choose:
              - conditions:
                  - condition: template
                    value_template: "{{ enable_fs and (fs_timer is string) and (fs_timer | length > 0) }}"
                sequence:
                  - action: timer.cancel
                    target:
                      entity_id: "{{ fs_timer }}"
            default: []
          - choose:
              - conditions:
                  - condition: template
                    value_template: "{{ latch_enabled }}"
                sequence:
                  - action: input_boolean.turn_off
                    target:
                      entity_id: "{{ latch }}"
            default: []
          - choose:
              - conditions:
                  - condition: template
                    value_template: "{{ exit_enabled }}"
                sequence:
                  - action: input_datetime.set_datetime
                    target:
                      entity_id: "{{ last_exit }}"
                    data:
                      timestamp: 0
            default: []
    default: []

  # ---------------------------------------------------------------------------
  # 6) Motion OFF for exit timeout: attempt clear (only if door is open)
  # FIX #11 (v4.2.4): exit_recent no longer overrides the sealed door guard.
  # ---------------------------------------------------------------------------
  - choose:
      - conditions:
          - condition: trigger
            id: motion_off_for
        sequence:
          - condition: state
            entity_id: !input occupancy_helper
            state: "on"
          # v4.2.2: Do not clear if any manual_occupied helper is still ON.
          - condition: template
            value_template: "{{ not manual_on }}"
          # exit_recent can substitute for a currently-open door, but NOT for a closed seal door.
          - condition: template
            value_template: "{{ any_transition_open or exit_recent }}"
          # FIX #11 (v4.2.4): Seal door closed ALWAYS blocks clearing.
          # exit_recent must NOT override this guard.
          - condition: template
            value_template: "{{ not sealed_now }}"
          - condition: template
            value_template: "{{ mm_clear_ok }}"
          - action: input_boolean.turn_off
            target:
              entity_id: "{{ occ }}"
          # FIX #3: Cancel fs_timer immediately after clearing occupancy.
          # With mode:restart, any new trigger arriving between here and the old
          # position at the end of the sequence would kill this run before the
          # cancel executed, leaving the failsafe timer orphaned and running.
          - choose:
              - conditions:
                  - condition: template
                    value_template: "{{ enable_fs and (fs_timer is string) and (fs_timer | length > 0) }}"
                sequence:
                  - action: timer.cancel
                    target:
                      entity_id: "{{ fs_timer }}"
            default: []
          - choose:
              - conditions:
                  - condition: template
                    value_template: "{{ latch_enabled }}"
                sequence:
                  - action: input_boolean.turn_off
                    target:
                      entity_id: "{{ latch }}"
            default: []
          - choose:
              - conditions:
                  - condition: template
                    value_template: "{{ exit_enabled }}"
                sequence:
                  - action: input_datetime.set_datetime
                    target:
                      entity_id: "{{ last_exit }}"
                    data:
                      timestamp: 0
            default: []
          # Also cancel a pending exit eval if motion-off-for clears first
          - action: timer.cancel
            target:
              entity_id: "{{ exit_eval_tmr }}"
    default: []

  # ---------------------------------------------------------------------------
  # 6b) mmWave OFF for exit timeout: attempt clear (requires PIR off too)
  # FIX #11 (v4.2.4): exit_recent no longer overrides the sealed door guard.
  # ---------------------------------------------------------------------------
  - choose:
      - conditions:
          - condition: trigger
            id: mmwave_off_for
        sequence:
          - condition: state
            entity_id: !input occupancy_helper
            state: "on"
          # v4.2.2: Do not clear if any manual_occupied helper is still ON.
          - condition: template
            value_template: "{{ not manual_on }}"
          # exit_recent can substitute for a currently-open door, but NOT for a closed seal door.
          - condition: template
            value_template: "{{ any_transition_open or exit_recent }}"
          # FIX #11 (v4.2.4): Seal door closed ALWAYS blocks clearing.
          # exit_recent must NOT override this guard.
          - condition: template
            value_template: "{{ not sealed_now }}"
          - condition: template
            value_template: "{{ is_state(motion, 'off') }}"
          - condition: template
            value_template: "{{ mm_clear_ok }}"
          - action: input_boolean.turn_off
            target:
              entity_id: "{{ occ }}"
          # FIX #3: Cancel fs_timer immediately after clearing occupancy.
          # With mode:restart, any new trigger arriving between here and the old
          # position at the end of the sequence would kill this run before the
          # cancel executed, leaving the failsafe timer orphaned and running.
          - choose:
              - conditions:
                  - condition: template
                    value_template: "{{ enable_fs and (fs_timer is string) and (fs_timer | length > 0) }}"
                sequence:
                  - action: timer.cancel
                    target:
                      entity_id: "{{ fs_timer }}"
            default: []
          - choose:
              - conditions:
                  - condition: template
                    value_template: "{{ latch_enabled }}"
                sequence:
                  - action: input_boolean.turn_off
                    target:
                      entity_id: "{{ latch }}"
            default: []
          - choose:
              - conditions:
                  - condition: template
                    value_template: "{{ exit_enabled }}"
                sequence:
                  - action: input_datetime.set_datetime
                    target:
                      entity_id: "{{ last_exit }}"
                    data:
                      timestamp: 0
            default: []
          - action: timer.cancel
            target:
              entity_id: "{{ exit_eval_tmr }}"
    default: []

  # ---------------------------------------------------------------------------
  # 7) Keep latch helper in sync on seal/door changes (debugging)
  # ---------------------------------------------------------------------------
  - choose:
      - conditions:
          - condition: template
            value_template: "{{ (trigger.id in ['transition_change','seal_change']) and latch_enabled }}"
        sequence:
          - choose:
              - conditions:
                  - condition: template
                    value_template: "{{ is_state(occ, 'on') and sealed_now }}"
                sequence:
                  - action: input_boolean.turn_on
                    target:
                      entity_id: "{{ latch }}"
              - conditions:
                  - condition: template
                    value_template: "{{ (not sealed_now) or is_state(occ, 'off') }}"
                sequence:
                  - action: input_boolean.turn_off
                    target:
                      entity_id: "{{ latch }}"
            default: []
    default: []

  # ---------------------------------------------------------------------------
  # 8) SAFE failsafe: only clears when exit is possible and motion is off.
  #    Hard deadlock break if motion has been off for 1.5x the failsafe duration.
  # FIX #11 (v4.2.4): exit_recent no longer overrides the sealed door guard
  # in Condition A. A closed seal door always causes a timer restart (Condition C).
  # ---------------------------------------------------------------------------
  - choose:
      - conditions:
          - condition: trigger
            id: failsafe_done
          - condition: template
            value_template: "{{ enable_fs and (fs_timer is string) and (fs_timer|length > 0) }}"
        sequence:
          - choose:
              # --- CONDITION A: Standard "Safe" Clear ---
              # Clear if: door is open (or recently exited) AND seal door is OPEN
              # AND motion is off AND mmWave clear.
              # v4.2.2: Also blocked if any manual_occupied helper is still ON.
              # v4.2.3: Also blocked if any force_occupied helper is still ON.
              # FIX #11 (v4.2.4): Seal door closed ALWAYS blocks — exit_recent
              # removed from the sealed guard. Both conditions must be true independently.
              - conditions:
                  - condition: state
                    entity_id: !input occupancy_helper
                    state: "on"
                  - condition: template
                    value_template: "{{ not manual_on }}"
                  # exit_recent can substitute for a currently-open door only.
                  - condition: template
                    value_template: "{{ (not sealed_now) or exit_recent }}"
                  # FIX #11 (v4.2.4): Seal door closed ALWAYS blocks clearing.
                  - condition: template
                    value_template: "{{ not sealed_now }}"
                  - condition: template
                    value_template: "{{ is_state(motion, 'off') }}"
                  - condition: template
                    value_template: "{{ mm_clear_ok }}"
                sequence:
                  - action: input_boolean.turn_off
                    target:
                      entity_id: "{{ occ }}"
                  - action: input_boolean.turn_off
                    target:
                      entity_id: "{{ latch }}"
                    enabled: "{{ latch_enabled }}"
                  - action: timer.cancel
                    target:
                      entity_id: "{{ exit_eval_tmr }}"

              # --- CONDITION B: Hard Deadlock Break ---
              # Clear if motion has been off for more than 1.5x the failsafe duration.
              # Handles "I left through the window" / unmonitored exit scenarios.
              # FIX #4: Guard against force_on — a forced-occupied room must not be
              # cleared by this deadlock break.
              # v4.2.2: Also guarded against manual_on (adjoining room still occupied).
              # v4.2.3: force_on now true if ANY force_occupied helper is ON.
              - conditions:
                  - condition: template
                    value_template: "{{ not force_on }}"
                  - condition: template
                    value_template: "{{ not manual_on }}"
                  - condition: template
                    value_template: >
                      {% set last_m = states(last_motion) %}
                      {% set seconds_idle = (now().timestamp() - as_timestamp(last_m, 0)) %}
                      {{ seconds_idle > (fs_min * 60 * 1.5) }}
                sequence:
                  - action: input_boolean.turn_off
                    target:
                      entity_id: "{{ occ }}"
                  - action: timer.cancel
                    target:
                      entity_id: "{{ exit_eval_tmr }}"

              # --- CONDITION C: Still Occupied / Sealed ---
              # None of the above cleared — restart the failsafe timer.
              - conditions:
                  - condition: state
                    entity_id: !input occupancy_helper
                    state: "on"
                sequence:
                  - action: timer.start
                    target:
                      entity_id: "{{ fs_timer }}"
                    data:
                      duration: "{{ fs_duration_hms }}"

  # ---------------------------------------------------------------------------
  # 9) Override turned OFF: no immediate action; next door/motion event updates.
  # ---------------------------------------------------------------------------
  - choose:
      - conditions:
          - condition: trigger
            id: override_off
        sequence: []
    default: []
