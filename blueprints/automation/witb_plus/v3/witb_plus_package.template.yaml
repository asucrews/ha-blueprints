# WITB+ package template
# Tokens:
#   - room_slug          -> replaced with generated slug (e.g. master_bedroom)
#   - Room Friendly Name -> replaced with friendly name (e.g. Master Bedroom)
#
# Optional blocks (comment markers):
#   # --- BEGIN helpers --- / # --- END helpers ---
#   # --- BEGIN templates --- / # --- END templates ---
#   # --- BEGIN controls --- / # --- END controls ---
#   # --- BEGIN no_controls --- / # --- END no_controls ---
#   # --- BEGIN latched --- / # --- END latched ---
#   # --- BEGIN failsafe --- / # --- END failsafe ---

# --- BEGIN helpers ---
input_boolean:
  room_slug_occupied:
    name: "Room Friendly Name Occupied"
    icon: mdi:account

# --- BEGIN controls ---
  room_slug_automation_override:
    name: "Room Friendly Name Automation Override"
    icon: mdi:toggle-switch-off-outline

  room_slug_force_occupied:
    name: "Room Friendly Name Force Occupied"
    icon: mdi:lock

  room_slug_manual_occupied:
    name: "Room Friendly Name Manual Occupied"
    icon: mdi:hand
# --- END controls ---

# --- BEGIN latched ---
  room_slug_latched:
    name: "Room Friendly Name Latched"
    icon: mdi:door-closed-lock
# --- END latched ---

input_datetime:
  room_slug_last_motion:
    name: "Room Friendly Name Last Motion"
    has_date: true
    has_time: true

  room_slug_last_door:
    name: "Room Friendly Name Last Door"
    has_date: true
    has_time: true

  room_slug_last_exit_door:
    name: "Room Friendly Name Last Exit Door"
    has_date: true
    has_time: true

# --- BEGIN failsafe ---
timer:
  room_slug_failsafe:
    name: "Room Friendly Name Failsafe"
# --- END failsafe ---
# --- END helpers ---

# --- BEGIN templates ---
# ---- Optional template sensors (dashboard/debug convenience) ----
template:
  - binary_sensor:
# --- BEGIN controls ---
      - name: "Room Friendly Name Occupied Effective"
        unique_id: room_slug_occupied_effective
        device_class: occupancy
        state: >
          {{ is_state('input_boolean.room_slug_occupied','on')
             or is_state('input_boolean.room_slug_force_occupied','on')
             or is_state('input_boolean.room_slug_manual_occupied','on') }}

      - name: "Room Friendly Name WITB Override Active"
        unique_id: room_slug_witb_override_active
        state: >
          {{ is_state('input_boolean.room_slug_automation_override','on')
             or is_state('input_boolean.room_slug_force_occupied','on')
             or is_state('input_boolean.room_slug_manual_occupied','on') }}
        icon: mdi:shield-check
# --- END controls ---

# --- BEGIN no_controls ---
      - name: "Room Friendly Name Occupied Effective"
        unique_id: room_slug_occupied_effective
        device_class: occupancy
        state: >
          {{ is_state('input_boolean.room_slug_occupied','on') }}
# --- END no_controls ---

  - sensor:
      - name: "Room Friendly Name Minutes Since Motion"
        unique_id: room_slug_minutes_since_motion
        unit_of_measurement: "min"
        state: >
          {% set v = states('input_datetime.room_slug_last_motion') %}
          {% if v in ['unknown','unavailable','none',''] %}
            999999
          {% else %}
            {{ ((as_timestamp(now()) - as_timestamp(v)) / 60) | int }}
          {% endif %}
# --- END templates ---
