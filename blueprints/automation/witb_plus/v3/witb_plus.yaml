blueprint:
  homeassistant:
    min_version: 2026.2.0
  domain: automation
  source_url: https://github.com/asucrews/ha-blueprints/blob/main/blueprints/automation/witb_plus/v3/witb_plus.yaml
  name: WITB+ v3.5
  description: >
    Wasp-in-the-Box (WITB) occupancy inference for a SINGLE room using:
      - 1 motion sensor (PIR)
      - 1+ transition door contact sensors (boundary crossings)
      - 1 seal door contact sensor (main/privacy door)

    Works when:
      - Seal door is closed while in use (prevents clearing even if motion stops)
      - Door is open OR closed when empty (door alone never asserts occupancy)

    Core rules:
      1) PIR motion is the default signal that ASSERTS occupied = ON (mmWave can optionally assert if enabled).
      2) Occupancy clears only when EXIT is possible:
         - occupied AND any transition door OPEN AND motion OFF for exit_timeout_seconds -> clear.
           (Clearing is blocked while seal door is CLOSED.)
      3) Optional SAFE failsafe timer (no polling):
         - When timer finishes, clear ONLY if SEAL door OPEN and motion OFF.
         - If SEAL door CLOSED, do NOT clear (sleeping/sitting still); restart the timer.
      4) Per-room controls (priority order):
         - automation_override ON: automation does nothing (hands off).
         - force_occupied ON: pins occupied ON and blocks clearing.
         - manual_occupied ON: asserts occupied ON but still allows normal exit-based clearing.

    Notes:
      - Configure transition_doors as the doors that represent leaving/entering this room's zone.
      - Configure seal_door as the main/privacy door that should block clearing while closed.
  input:
    seal_door:
      name: Seal Door (main/privacy door)
      description: >
        The room's MAIN door used for "sealed" semantics (failsafe / still-occupant protection).
        Sealed means this door is CLOSED. This door does NOT have to be the only transition door.
      selector:
        entity:
          domain: binary_sensor
          device_class: door

    transition_doors:
      name: Transition Doors (1+)
      description: >
        Doors that represent leaving/entering this room's zone (movement/transition semantics).
        Select one or more. Include the seal door here if it is also a transition door.
      selector:
        entity:
          domain: binary_sensor
          device_class: door
          multiple: true

    motion_sensor:
      name: Motion Sensor (PIR)
      selector:
        entity:
          domain: binary_sensor
          device_class: motion


    mmwave_sensor:
      name: mmWave Presence Sensor (optional)
      description: >
        Optional presence/occupancy binary_sensor (e.g., mmWave).
        When configured, it can block clearing while ON (recommended), and can optionally
        assert occupancy when ON (if enabled below).
      default: []
      selector:
        entity:
          domain: binary_sensor

    mmwave_blocks_clear:
      name: mmWave blocks clearing while ON
      description: >
        If enabled and mmWave is configured, occupancy will not clear while mmWave is ON.
      default: true
      selector:
        boolean: {}

    mmwave_asserts_occupied:
      name: Allow mmWave to assert occupancy
      description: >
        If enabled and mmWave is configured, mmWave ON can assert occupied ON (subject to entry gating if enabled).
        Leave disabled if your mmWave can see through walls or adjacent rooms.
      default: false
      selector:
        boolean: {}
    occupancy_helper:
      name: Occupancy Helper (input_boolean)
      selector:
        entity:
          domain: input_boolean

    last_motion_helper:
      name: Last Motion Helper (input_datetime)
      description: Stores timestamp of last motion ON.
      selector:
        entity:
          domain: input_datetime

    last_door_helper:
      name: Last Door Helper (input_datetime)
      description: Stores timestamp of last door state change.
      selector:
        entity:
          domain: input_datetime


    last_exit_door_helper:
      name: Last Exit Door Helper (optional, input_datetime)
      description: >
        Optional helper used to support "door can close after leaving" rooms.
        This stores the timestamp when a transition/seal door OPENED while the room was already occupied.
        If set, the automation can clear occupancy after the door closes behind you (garage/bedroom style).
      default: []
      selector:
        entity:
          domain: input_datetime

    exit_recent_window_seconds:
      name: Exit-Close Window (seconds)
      description: >
        How long after a door OPENED while occupied we still treat exit as possible, even if the door is now closed.
        Must be >= Exit Timeout to cover "open -> close -> motion stops" sequences.
      default: 180
      selector:
        number:
          min: 30
          max: 900
          unit_of_measurement: seconds
          mode: slider

    latched_helper:
      name: Latched Helper (optional, input_boolean)
      description: >
        Optional debug/helper: ON when the SEAL door is closed while occupied.
        OFF when the SEAL door opens or occupancy clears.
      default: []
      selector:
        entity:
          domain: input_boolean

    exit_timeout_seconds:
      name: Exit Timeout (seconds)
      description: When occupied and door is OPEN, if no motion for this long -> clear occupancy.
      default: 60
      selector:
        number:
          min: 5
          max: 600
          unit_of_measurement: seconds
          mode: slider

    # Per-room controls
    automation_override:
      name: Automation Override (optional)
      description: If ON, this automation does nothing (hands off).
      default: []
      selector:
        entity:
          domain: input_boolean

    force_occupied:
      name: Force Occupied (optional)
      description: If ON, pins occupancy ON and blocks clearing.
      default: []
      selector:
        entity:
          domain: input_boolean

    manual_occupied:
      name: Manual Occupied (optional)
      description: If ON, asserts occupancy ON but still allows normal exit-based clearing.
      default: []
      selector:
        entity:
          domain: input_boolean

    # Optional entry gating (prevents "walk-by" false positives in open-door sightlines)
    require_door_for_entry:
      name: Require recent door event for entry
      description: >
        If enabled, motion will assert occupancy only if a door event occurred within entry_window_seconds,
        OR the door is currently CLOSED, OR occupancy is already ON.
      default: false
      selector:
        boolean: {}

    entry_window_seconds:
      name: Entry window (seconds)
      description: How recent a door change must be to accept motion as an entry when gating is enabled.
      default: 15
      selector:
        number:
          min: 1
          max: 60
          unit_of_measurement: seconds
          mode: slider

    # Safe failsafe (optional)
    enable_failsafe:
      name: Enable failsafe timer
      description: >
        If enabled, uses a timer (no polling) to prevent stuck occupied states.
        SAFE behavior: failsafe will never clear while door is CLOSED.
      default: true
      selector:
        boolean: {}

    failsafe_timer:
      name: Failsafe Timer (optional, required if enabled)
      description: Create one per room (e.g., timer.toilet_failsafe). Only used when failsafe is enabled.
      default: []
      selector:
        entity:
          domain: timer

    failsafe_minutes:
      name: Failsafe duration (minutes)
      description: >
        Duration loaded into the failsafe timer whenever occupancy is asserted/renewed.
        Toilet suggestion: 90-180. Bedroom suggestion: 720-1440.
      default: 180
      selector:
        number:
          min: 5
          max: 1440
          unit_of_measurement: minutes
          mode: slider

mode: restart
max_exceeded: silent

variables:
  seal: !input seal_door
  doors: !input transition_doors
  motion: !input motion_sensor
  mm: !input mmwave_sensor
  mm_block: !input mmwave_blocks_clear
  mm_assert: !input mmwave_asserts_occupied
  mm_enabled: "{{ mm is string and mm|length > 0 }}"
  mm_on: "{{ mm_enabled and is_state(mm, 'on') }}"
  mm_clear_ok: "{{ (not mm_enabled) or (not mm_block) or is_state(mm, 'off') }}"
  occ: !input occupancy_helper
  last_motion: !input last_motion_helper
  last_door: !input last_door_helper
  latch: !input latched_helper

  exit_s: !input exit_timeout_seconds

  # Controls
  ov: !input automation_override
  force: !input force_occupied
  manual: !input manual_occupied

  # Entry gating
  require_door: !input require_door_for_entry
  entry_s: !input entry_window_seconds

  # Failsafe
  enable_fs: !input enable_failsafe
  fs_timer: !input failsafe_timer
  fs_min: !input failsafe_minutes

  # Door semantics
  sealed_now: "{{ is_state(seal, 'off') }}"
  any_transition_open: >-
    {% set ds = doors if doors is not string else [doors] %}
    {% set ns = namespace(open=false) %}
    {% for d in ds %}
      {% if is_state(d, 'on') %}
        {% set ns.open = true %}
      {% endif %}
    {% endfor %}
    {{ ns.open }}

  # Helpers
  latch_enabled: "{{ latch is string and latch|length > 0 }}"
  ov_on: >-
    {% if ov is string and ov|length > 0 %}
      {{ is_state(ov, 'on') }}
    {% else %}
      false
    {% endif %}
  force_on: >-
    {% if force is string and force|length > 0 %}
      {{ is_state(force, 'on') }}
    {% else %}
      false
    {% endif %}
  manual_on: >-
    {% if manual is string and manual|length > 0 %}
      {{ is_state(manual, 'on') }}
    {% else %}
      false
    {% endif %}

  # minutes -> HH:MM:SS
  fs_duration_hms: >-
    {% set m = (fs_min | int) %}
    {% set h = (m // 60) %}
    {% set mm = (m % 60) %}
    {{ '%02d:%02d:00' | format(h, mm) }}

  # For entry gating: seconds since last door change
  last_door_ts: >-
    {% set v = states(last_door) %}
    {% if v in ['unknown','unavailable','none',''] %}
      0
    {% else %}
      {{ as_timestamp(v) | int }}
    {% endif %}
  seconds_since_door: "{{ (now().timestamp() | int) - (last_door_ts | int) }}"


  # For "door can close after leaving": timestamp when a door OPENED while already occupied
  last_exit: !input last_exit_door_helper
  exit_win_s: !input exit_recent_window_seconds
  exit_enabled: "{{ last_exit is string and last_exit|length > 0 }}"
  last_exit_ts: >-
    {% if exit_enabled %}
      {% set v = states(last_exit) %}
      {% if v in ['unknown','unavailable','none',''] %}
        0
      {% else %}
        {{ as_timestamp(v) | int }}
      {% endif %}
    {% else %}
      0
    {% endif %}
  seconds_since_exit: "{{ (now().timestamp() | int) - (last_exit_ts | int) }}"
  exit_recent: "{{ exit_enabled and (seconds_since_exit | int) <= (exit_win_s | int) }}"


trigger:
  - id: motion_on
    platform: state
    entity_id: !input motion_sensor
    to: "on"

  - id: mmwave_on
    platform: template
    value_template: "{{ mm_enabled and is_state(mm, 'on') }}"

  - id: mmwave_off_for
    platform: template
    value_template: "{{ mm_enabled and is_state(mm, 'off') }}"
    for:
      seconds: !input exit_timeout_seconds

  - id: transition_change
    platform: state
    entity_id: !input transition_doors

  - id: transition_open
    platform: state
    entity_id: !input transition_doors
    to: "on"

  - id: seal_change
    platform: state
    entity_id: !input seal_door

  - id: seal_open
    platform: state
    entity_id: !input seal_door
    to: "on"

  - id: motion_off_for
    platform: state
    entity_id: !input motion_sensor
    to: "off"
    for:
      seconds: !input exit_timeout_seconds

  # Control toggles (act immediately)
  - id: override_off
    platform: state
    entity_id: !input automation_override
    to: "off"

  - id: force_on
    platform: state
    entity_id: !input force_occupied
    to: "on"

  - id: force_off
    platform: state
    entity_id: !input force_occupied
    to: "off"

  - id: manual_on
    platform: state
    entity_id: !input manual_occupied
    to: "on"

  - id: manual_off
    platform: state
    entity_id: !input manual_occupied
    to: "off"

  # Optional failsafe completion
  - id: failsafe_done
    platform: event
    event_type: timer.finished
    event_data:
      entity_id: !input failsafe_timer

# If override is ON, do nothing at all
condition:
  - condition: template
    value_template: "{{ not ov_on }}"

action:
  # 1) Keep last_door updated on any door change (for debugging + entry gating)
  - choose:
      - conditions:
          - condition: template
            value_template: "{{ trigger.id in ['transition_change','seal_change'] }}"
        sequence:
          - service: input_datetime.set_datetime
            target:
              entity_id: "{{ last_door }}"
            data:
              timestamp: "{{ now().timestamp() }}"
    default: []


  # 1b) Mark a "possible exit" when a door OPENS while already occupied.
  #     This enables clearing even if the door closes behind you.
  - choose:
      - conditions:
          - condition: template
            value_template: "{{ trigger.id in ['transition_open','seal_open'] and exit_enabled }}"
          - condition: state
            entity_id: !input occupancy_helper
            state: "on"
        sequence:
          - service: input_datetime.set_datetime
            target:
              entity_id: "{{ last_exit }}"
            data:
              timestamp: "{{ now().timestamp() }}"
    default: []


  # 2) Force Occupied: pin ON and block clearing
  - choose:
      - conditions:
          - condition: template
            value_template: "{{ force_on }}"
        sequence:
          - service: input_boolean.turn_on
            target:
              entity_id: "{{ occ }}"
          - service: input_datetime.set_datetime
            target:
              entity_id: "{{ last_motion }}"
            data:
              timestamp: "{{ now().timestamp() }}"
          - choose:
              - conditions:
                  - condition: template
                    value_template: "{{ latch_enabled and is_state(seal, 'off') }}"
                sequence:
                  - service: input_boolean.turn_on
                    target:
                      entity_id: "{{ latch }}"
            default: []
          - choose:
              - conditions:
                  - condition: template
                    value_template: "{{ enable_fs and (fs_timer is string) and (fs_timer|length > 0) }}"
                sequence:
                  - service: timer.start
                    target:
                      entity_id: "{{ fs_timer }}"
                    data:
                      duration: "{{ fs_duration_hms }}"
            default: []
          # Stop here; do not run normal clearing logic when forced
          - stop: "Force occupied active"
    default: []

  # 3) Manual Occupied: assert ON (soft); allow normal exit-based clearing
  - choose:
      - conditions:
          - condition: template
            value_template: "{{ manual_on }}"
        sequence:
          - service: input_boolean.turn_on
            target:
              entity_id: "{{ occ }}"
          - service: input_datetime.set_datetime
            target:
              entity_id: "{{ last_motion }}"
            data:
              timestamp: "{{ now().timestamp() }}"
          - choose:
              - conditions:
                  - condition: template
                    value_template: "{{ latch_enabled and is_state(seal, 'off') }}"
                sequence:
                  - service: input_boolean.turn_on
                    target:
                      entity_id: "{{ latch }}"
            default: []
          - choose:
              - conditions:
                  - condition: template
                    value_template: "{{ enable_fs and (fs_timer is string) and (fs_timer|length > 0) }}"
                sequence:
                  - service: timer.start
                    target:
                      entity_id: "{{ fs_timer }}"
                    data:
                      duration: "{{ fs_duration_hms }}"
            default: []
    default: []

  # 4) Motion ON asserts occupancy (with optional entry gating)
  - choose:
      - conditions:
          - condition: trigger
            id: motion_on
        sequence:
          - choose:
              - conditions:
                  - condition: template
                    value_template: >
                      {% if not require_door %}
                        true
                      {% else %}
                        {{ is_state(seal,'off') or (seconds_since_door <= (entry_s | int)) or is_state(occ,'on') }}
                      {% endif %}
                sequence:
                  - service: input_boolean.turn_on
                    target:
                      entity_id: "{{ occ }}"
                  - service: input_datetime.set_datetime
                    target:
                      entity_id: "{{ last_motion }}"
                    data:
                      timestamp: "{{ now().timestamp() }}"
                  - choose:
                      - conditions:
                          - condition: template
                            value_template: "{{ latch_enabled and is_state(seal,'off') }}"
                        sequence:
                          - service: input_boolean.turn_on
                            target:
                              entity_id: "{{ latch }}"
                    default: []
                  - choose:
                      - conditions:
                          - condition: template
                            value_template: "{{ enable_fs and (fs_timer is string) and (fs_timer|length > 0) }}"
                        sequence:
                          - service: timer.start
                            target:
                              entity_id: "{{ fs_timer }}"
                            data:
                              duration: "{{ fs_duration_hms }}"
                    default: []
            default: []
    default: []

  # 4b) mmWave ON (optional): refresh presence; optionally assert occupancy
  - choose:
      - conditions:
          - condition: trigger
            id: mmwave_on
        sequence:
          # If allowed, mmWave can assert occupancy (subject to entry gating).
          - choose:
              - conditions:
                  - condition: template
                    value_template: "{{ mm_assert }}"
                sequence:
                  - choose:
                      - conditions:
                          - condition: template
                            value_template: >
                              {% if not require_door %}
                                true
                              {% else %}
                                {{ is_state(seal,'off') or (seconds_since_door <= (entry_s | int)) or is_state(occ,'on') }}
                              {% endif %}
                        sequence:
                          - service: input_boolean.turn_on
                            target:
                              entity_id: "{{ occ }}"
                    default: []
            default: []

          # Refresh timestamps/failsafe when occupied (including right after asserting)
          - choose:
              - conditions:
                  - condition: state
                    entity_id: !input occupancy_helper
                    state: "on"
                sequence:
                  - service: input_datetime.set_datetime
                    target:
                      entity_id: "{{ last_motion }}"
                    data:
                      timestamp: "{{ now().timestamp() }}"
                  - choose:
                      - conditions:
                          - condition: template
                            value_template: "{{ latch_enabled and is_state(seal,'off') }}"
                        sequence:
                          - service: input_boolean.turn_on
                            target:
                              entity_id: "{{ latch }}"
                    default: []
                  - choose:
                      - conditions:
                          - condition: template
                            value_template: "{{ enable_fs and (fs_timer is string) and (fs_timer|length > 0) }}"
                        sequence:
                          - service: timer.start
                            target:
                              entity_id: "{{ fs_timer }}"
                            data:
                              duration: "{{ fs_duration_hms }}"
                    default: []
            default: []
    default: []
  # 5) Door open: delayed exit evaluation (handles quick open/close)
  - choose:
      - conditions:
          - condition: template
            value_template: "{{ trigger.id in ['transition_open','seal_open'] }}"
        sequence:
          - delay:
              seconds: !input exit_timeout_seconds
          - condition: state
            entity_id: !input occupancy_helper
            state: "on"
          - condition: template
            value_template: "{{ any_transition_open or exit_recent }}"
          - condition: template
            value_template: "{{ (not sealed_now) or exit_recent }}"
          - condition: template
            value_template: "{{ is_state(motion, 'off') }}"
          - condition: template
            value_template: "{{ mm_clear_ok }}"
          - service: input_boolean.turn_off
            target:
              entity_id: "{{ occ }}"
          - choose:
              - conditions:
                  - condition: template
                    value_template: "{{ latch_enabled }}"
                sequence:
                  - service: input_boolean.turn_off
                    target:
                      entity_id: "{{ latch }}"
            default: []

          - choose:
              - conditions:
                  - condition: template
                    value_template: "{{ exit_enabled }}"
                sequence:
                  - service: input_datetime.set_datetime
                    target:
                      entity_id: "{{ last_exit }}"
                    data:
                      timestamp: 0
            default: []
    default: []

  # 6) Motion OFF for exit timeout: attempt clear (only if door is open)
  - choose:
      - conditions:
          - condition: trigger
            id: motion_off_for
        sequence:
          - condition: state
            entity_id: !input occupancy_helper
            state: "on"
          - condition: template
            value_template: "{{ any_transition_open or exit_recent }}"
          - condition: template
            value_template: "{{ (not sealed_now) or exit_recent }}"
          - condition: template
            value_template: "{{ mm_clear_ok }}"
          - service: input_boolean.turn_off
            target:
              entity_id: "{{ occ }}"
          - choose:
              - conditions:
                  - condition: template
                    value_template: "{{ latch_enabled }}"
                sequence:
                  - service: input_boolean.turn_off
                    target:
                      entity_id: "{{ latch }}"
            default: []

          - choose:
              - conditions:
                  - condition: template
                    value_template: "{{ exit_enabled }}"
                sequence:
                  - service: input_datetime.set_datetime
                    target:
                      entity_id: "{{ last_exit }}"
                    data:
                      timestamp: 0
            default: []
    default: []

  # 6b) mmWave OFF for exit timeout: attempt clear (requires PIR off too)
  - choose:
      - conditions:
          - condition: trigger
            id: mmwave_off_for
        sequence:
          - condition: state
            entity_id: !input occupancy_helper
            state: "on"
          - condition: template
            value_template: "{{ any_transition_open or exit_recent }}"
          - condition: template
            value_template: "{{ (not sealed_now) or exit_recent }}"
          - condition: template
            value_template: "{{ is_state(motion, 'off') }}"
          - condition: template
            value_template: "{{ mm_clear_ok }}"
          - service: input_boolean.turn_off
            target:
              entity_id: "{{ occ }}"
          - choose:
              - conditions:
                  - condition: template
                    value_template: "{{ latch_enabled }}"
                sequence:
                  - service: input_boolean.turn_off
                    target:
                      entity_id: "{{ latch }}"
            default: []
          - choose:
              - conditions:
                  - condition: template
                    value_template: "{{ exit_enabled }}"
                sequence:
                  - service: input_datetime.set_datetime
                    target:
                      entity_id: "{{ last_exit }}"
                    data:
                      timestamp: 0
            default: []
    default: []
  # 7) Keep latch helper in sync on seal door changes (debugging only)
  - choose:
      - conditions:
          - condition: template
            value_template: "{{ (trigger.id in ['transition_change','seal_change']) and latch_enabled }}"
        sequence:
          - choose:
              - conditions:
                  - condition: template
                    value_template: "{{ is_state(occ, 'on') and sealed_now }}"
                sequence:
                  - service: input_boolean.turn_on
                    target:
                      entity_id: "{{ latch }}"
              - conditions:
                  - condition: template
                    value_template: "{{ (not sealed_now) or is_state(occ, 'off') }}"
                sequence:
                  - service: input_boolean.turn_off
                    target:
                      entity_id: "{{ latch }}"
            default: []
    default: []

  # 8) SAFE failsafe: only clears when exit is possible (door open) and motion is off.
  #    Otherwise, if still occupied, restart timer (no clearing while door closed).
  - choose:
      - conditions:
          - condition: trigger
            id: failsafe_done
          - condition: template
            value_template: "{{ enable_fs and (fs_timer is string) and (fs_timer|length > 0) }}"
        sequence:
          - choose:
              - conditions:
                  - condition: state
                    entity_id: !input occupancy_helper
                    state: "on"
                sequence:
                  - choose:
                      - conditions:
                          - condition: template
                            value_template: "{{ (not sealed_now) or exit_recent }}"
                          - condition: template
                            value_template: "{{ is_state(motion, 'off') }}"
                          - condition: template
                            value_template: "{{ mm_clear_ok }}"
                        sequence:
                          - service: input_boolean.turn_off
                            target:
                              entity_id: "{{ occ }}"
                          - choose:
                              - conditions:
                                  - condition: template
                                    value_template: "{{ latch_enabled }}"
                                sequence:
                                  - service: input_boolean.turn_off
                                    target:
                                      entity_id: "{{ latch }}"
                            default: []
                          - choose:
                              - conditions:
                                  - condition: template
                                    value_template: "{{ exit_enabled }}"
                                sequence:
                                  - service: input_datetime.set_datetime
                                    target:
                                      entity_id: "{{ last_exit }}"
                                    data:
                                      timestamp: 0
                            default: []
                      - conditions:
                          - condition: template
                            value_template: "true"
                        sequence:
                          - service: timer.start
                            target:
                              entity_id: "{{ fs_timer }}"
                            data:
                              duration: "{{ fs_duration_hms }}"
                    default: []
            default: []
    default: []

  # 9) When override is turned OFF, we don't force anything immediately; next door/motion will update.
  - choose:
      - conditions:
          - condition: trigger
            id: override_off
        sequence: []
    default: []
