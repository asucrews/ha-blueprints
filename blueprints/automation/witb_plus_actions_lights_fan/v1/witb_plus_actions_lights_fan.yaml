blueprint:
  homeassistant:
    min_version: 2026.2.0
  domain: automation
  source_url: https://github.com/asucrews/ha-blueprints/blob/main/blueprints/automation/witb_plus_actions_lights_fan/v1/witb_plus_actions_lights_fan.yaml
  name: WITB+ Actions - Lights + Fan (single automation) v1.6
  description: |
    Version: 1.6
      Adds optional Light ON/OFF script hooks (per-room bulb+switch logic).
      Adds input sections (requires Home Assistant 2024.6.0+).
      Adds "tune from dashboard" support:
      - Optional input_number helpers can override:
          * illuminance_threshold (lux)
          * humidity_high / humidity_low (%)
          * fan_on_delay (seconds)

    v1.4 features included:
      - Fan ON delay (avoid starting exhaust fans for very short trips).
      - Humidity hold for fan (keeps fan running if humidity is still high; uses hysteresis + max hold time).
      - Optional lux-based light gating (use a room illuminance sensor instead of sun position).

    Pair with WITB+ Use the room's effective occupancy sensor:
      - binary_sensor.<slug>_occupied_effective

    Safety / "don't fight me" rules:
      - automation_override ON => do nothing (no ON, no OFF).
      - force_occupied OR manual_occupied ON => blocks vacancy OFF actions.
      - Auto-tag booleans (recommended): if provided, OFF actions only happen when the tag is ON.
        This prevents turning off lights/fans that were turned on manually.
      - Humidity-hold only applies when auto_tag_fan is provided and ON (so we don't interfere with manual fan runs).
  input:
    core:
      name: Core
      icon: mdi:home-assistant
      description: Required occupancy + optional override/cooldown/startup protections.
      collapsed: false
      input:
        occupied_effective:
          name: Effective occupancy sensor (WITB+)
          description: Use the room's effective occupancy sensor (binary_sensor.<slug>_occupied_effective).
          selector:
            entity:
              domain: binary_sensor
        automation_override:
          name: Automation override (optional)
          description: If set and ON, the blueprint performs no actions (no ON, no OFF).
          default: ''
          selector:
            entity:
              domain: input_boolean
        force_occupied:
          name: Force occupied (optional)
          description: If set and ON, blocks vacancy OFF actions.
          default: ''
          selector:
            entity:
              domain: input_boolean
        manual_occupied:
          name: Manual occupied (optional)
          description: If set and ON, blocks vacancy OFF actions.
          default: ''
          selector:
            entity:
              domain: input_boolean
        startup_cleanup:
          name: Startup cleanup (recommended)
          description: |
            If true, after Home Assistant starts, this blueprint can turn off auto-tagged lights/fan when the room is vacant and no run-on timer is active. Helps recover when HA was down.
          default: true
          selector:
            boolean: null
        startup_cleanup_delay:
          name: Startup cleanup delay
          description: Delay after HA start before running cleanup (lets entities load).
          default: 00:00:10
          selector:
            duration: null
        on_debounce:
          name: Occupied debounce
          description: Require occupied_effective to be ON for this long before running ON actions.
          default: 00:00:00
          selector:
            duration: null
        cooldown_timer:
          name: Cooldown timer (optional)
          description: |
            Optional. If set, this blueprint starts the timer after running ON actions. While the timer is active, additional ON triggers are ignored (prevents rapid toggles).
          default: ''
          selector:
            entity:
              domain: timer
        cooldown_duration:
          name: Cooldown duration
          description: Duration used when starting cooldown_timer.
          default: 00:00:30
          selector:
            duration: null
    lights:
      name: Lights
      icon: mdi:lightbulb
      description: Light targets and behavior. Leave lights empty to disable light control.
      collapsed: false
      input:
        lights:
          name: Lights to control
          description: Lights this automation may turn on/off. Leave empty to disable light control.
          default: []
          selector:
            entity:
              domain: light
              multiple: true
        auto_tag_lights:
          name: Auto-tag boolean for lights (recommended)
          description: |
            Optional. If provided, this tag is set ON when this automation turns lights ON. On vacancy, lights will only be turned OFF if this tag is ON, then the tag is cleared. This prevents turning off lights that were turned on manually.
          default: ''
          selector:
            entity:
              domain: input_boolean
        lights_on_script:
          name: Lights ON script (optional)
          description: |
            Optional. If set, this blueprint calls this script instead of light.turn_on when it wants to turn lights ON.
            Use this for bulb+switch combos (Zooz/Aeotec/etc) or any room-specific logic.
            Passed variables:
              - brightness_pct (computed day/night profile)
              - transition (seconds)
              - lights (the selected lights list; may be empty)
              - is_night, lux_value, lux_threshold
              - reason = "occupied_on"
          default: ''
          selector:
            entity:
              domain: script
        lights_off_script:
          name: Lights OFF script (optional)
          description: |
            Optional. If set, this blueprint calls this script instead of light.turn_off when it wants to turn lights OFF.
            Passed variables:
              - transition (seconds)
              - lights (the selected lights list; may be empty)
              - is_night, lux_value, lux_threshold
              - reason = "vacant_lights_off" or "startup_cleanup"
          default: ''
          selector:
            entity:
              domain: script
        transition_on:
          name: 'Lights: ON transition seconds'
          description: Fade time when turning lights ON.
          default: 1
          selector:
            number:
              min: 0
              max: 30
              mode: slider
        transition_off:
          name: 'Lights: OFF transition seconds'
          description: Fade time when turning lights OFF.
          default: 2
          selector:
            number:
              min: 0
              max: 60
              mode: slider
        skip_on_if_any_light_on:
          name: 'Lights: skip turning ON if any target light is already ON'
          description: If true, prevents resetting brightness if someone already turned a target light on.
          default: true
          selector:
            boolean: null
        lights_off_delay:
          name: 'Lights: off-delay after vacancy'
          description: Require occupied_effective to be OFF for this long before turning lights OFF.
          default: 00:02:00
          selector:
            duration: null
    light_gating:
      name: Light gating
      icon: mdi:weather-night
      description: 'Optional gating: only turn lights on when dark (sun) or below a lux threshold.'
      collapsed: true
      input:
        turn_on_only_if_dark:
          name: 'Lights: only turn ON when dark (sun)'
          description: If true and no lux sensor is configured, lights will only be turned on when sun is below the horizon.
          default: true
          selector:
            boolean: null
        use_illuminance_gate:
          name: 'Lights: use illuminance sensor gate'
          description: If true and illuminance_entity is set, only turn lights on when lux is below the (static or helper)
            threshold.
          default: true
          selector:
            boolean: null
        illuminance_entity:
          name: 'Lights: illuminance sensor (optional)'
          description: |
            Optional. If set and use_illuminance_gate is true, this replaces the sun-based dark check. Example: sensor.<slug>_illuminance (lux).
          default: ''
          selector:
            entity:
              domain: sensor
        illuminance_threshold:
          name: 'Lights: illuminance threshold (lux) (static)'
          description: Used when illuminance_threshold_helper is not provided.
          default: 30
          selector:
            number:
              min: 0
              max: 5000
              mode: box
        illuminance_threshold_helper:
          name: 'Lights: illuminance threshold helper (optional input_number)'
          description: |
            Optional. If set, this input_number overrides illuminance_threshold at runtime (so you can tune in dashboards). Example: input_number.<slug>_actions_lux_threshold
          default: ''
          selector:
            entity:
              domain: input_number
    night_profile:
      name: Night profile
      icon: mdi:clock-outline
      description: Optional day/night brightness profile based on a time window.
      collapsed: true
      input:
        use_night_profile:
          name: 'Lights: use night brightness profile'
          description: If true, uses brightness_night_pct during the night window; otherwise uses brightness_day_pct.
          default: true
          selector:
            boolean: null
        night_start:
          name: Night start
          description: Start time for night window (used by night brightness profile and optional fan night disable).
          default: 00:00:00
          selector:
            time: null
        night_end:
          name: Night end
          description: End time for night window (supports crossing midnight).
          default: 06:00:00
          selector:
            time: null
        brightness_day_pct:
          name: 'Lights: day brightness %'
          description: Brightness percent used outside the night window (1-100).
          default: 100
          selector:
            number:
              min: 1
              max: 100
              mode: slider
        brightness_night_pct:
          name: 'Lights: night brightness %'
          description: Brightness percent used during the night window (1-100).
          default: 20
          selector:
            number:
              min: 1
              max: 100
              mode: slider
    fan_basic:
      name: Fan
      icon: mdi:fan
      description: Fan targets and basic behavior. Leave fan_entity/fan_switches empty to disable fan control.
      collapsed: false
      input:
        fan_entity:
          name: Fan entity (optional) - fan.*
          description: |
            Optional. Use a fan.* entity when you want speed/percentage or preset_mode control. If set, it takes precedence over fan_switches.
          default: ''
          selector:
            entity:
              domain: fan
        fan_switches:
          name: Fan switches (optional) - switch.* (on/off only)
          description: |
            Optional. Use for bathroom fans or any fan controlled by a relay/wall switch. Only ON/OFF is supported. Ignored if fan_entity is set.
          default: []
          selector:
            entity:
              domain: switch
              multiple: true
        auto_tag_fan:
          name: Auto-tag boolean for fan (recommended)
          description: |
            Optional. If provided, this tag is set ON when this automation turns the fan/switches ON. On vacancy, fan/switches will only be turned OFF if this tag is ON, then the tag is cleared. This prevents turning off a fan that was turned on manually.
          default: ''
          selector:
            entity:
              domain: input_boolean
        fan_turn_on_on_occupy:
          name: 'Fan: turn ON on occupancy'
          description: If true, attempts to turn on fan_entity or fan_switches on occupied.
          default: true
          selector:
            boolean: null
        fan_turn_off_on_vacant:
          name: 'Fan: turn OFF when vacant'
          description: |
            If true, turns fan OFF after vacancy. If fan_runon_timer is set, fan turns off when that timer finishes. If fan_runon_timer is not set, fan turns off after lights_off_delay.
          default: true
          selector:
            boolean: null
        fan_skip_on_if_already_on:
          name: 'Fan: skip ON if already ON'
          description: If true and fan_entity is already on, skips turning it on / setting speed again.
          default: true
          selector:
            boolean: null
        fan_disable_during_night:
          name: 'Fan: do NOT turn ON during night window'
          description: |
            If true, the fan ON action is skipped during the night window. Vacancy OFF behavior is unchanged (still controlled by fan_turn_off_on_vacant + auto_tag_fan).
          default: false
          selector:
            boolean: null
    fan_timing:
      name: Fan timing
      icon: mdi:timer-outline
      description: Optional fan on-delay and run-on behavior.
      collapsed: true
      input:
        fan_on_delay:
          name: 'Fan: ON delay after occupancy (static)'
          description: Wait this long after occupied before turning the fan ON (used when fan_on_delay_seconds_helper is not
            provided).
          default: 00:00:00
          selector:
            duration: null
        fan_on_delay_seconds_helper:
          name: 'Fan: ON delay helper (optional input_number seconds)'
          description: |
            Optional. If set, this input_number (seconds) overrides fan_on_delay at runtime (tune from dashboards). Example: input_number.<slug>_actions_fan_on_delay_seconds
          default: ''
          selector:
            entity:
              domain: input_number
        fan_runon_timer:
          name: 'Fan: run-on timer helper (optional)'
          description: |
            Optional but recommended if you want the fan to stay ON longer than lights after vacancy. Provide a timer.<slug>_fan_runon helper. When the run-on timer finishes, the fan is turned OFF (only if the room is still vacant). If left blank, fan OFF falls back to lights_off_delay.
          default: ''
          selector:
            entity:
              domain: timer
        fan_runon_duration:
          name: 'Fan: run-on duration'
          description: Duration used when starting fan_runon_timer.
          default: 00:10:00
          selector:
            duration: null
        fan_runon_starts_after_lights_off:
          name: 'Fan: start run-on AFTER lights turn off'
          description: |
            If true (recommended), the run-on timer starts when the lights-off delay completes. This ensures the fan gets the full run-on time AFTER lights are off. If false, the run-on timer starts immediately when vacancy begins.
          default: true
          selector:
            boolean: null
    fan_profile:
      name: Fan speed profile
      icon: mdi:fan-speed-1
      description: Optional day/night fan speed or preset selection (fan.* only).
      collapsed: true
      input:
        fan_use_night_profile:
          name: 'Fan: use night profile (percentage/preset)'
          description: If true and using fan_entity, uses the night fan percentage/preset during the night window.
          default: false
          selector:
            boolean: null
        fan_percentage_day:
          name: 'Fan: day percentage (0 = don''t set)'
          description: 'If using fan_entity: 1-100 sets percentage after turning on; 0 means skip setting percentage.'
          default: 0
          selector:
            number:
              min: 0
              max: 100
              mode: slider
        fan_percentage_night:
          name: 'Fan: night percentage (0 = don''t set)'
          description: 'If using fan_entity + fan_use_night_profile: 1-100 sets percentage at night; 0 means skip.'
          default: 0
          selector:
            number:
              min: 0
              max: 100
              mode: slider
        fan_preset_day:
          name: 'Fan: day preset_mode (optional)'
          description: 'If using fan_entity: preset_mode string to set after turning on. Leave blank to skip.'
          default: ''
          selector:
            text: null
        fan_preset_night:
          name: 'Fan: night preset_mode (optional)'
          description: 'If using fan_entity + fan_use_night_profile: preset_mode string to set at night. Leave blank to skip.'
          default: ''
          selector:
            text: null
    humidity_hold:
      name: Humidity hold
      icon: mdi:water-percent
      description: 'Optional: keep fan running while humidity remains high (requires humidity_entity).'
      collapsed: true
      input:
        humidity_entity:
          name: 'Fan: humidity sensor (optional)'
          description: |
            Optional. Provide a bathroom humidity sensor (percent). If set, the fan can stay on after run-on while humidity remains high (requires auto_tag_fan).
          default: ''
          selector:
            entity:
              domain: sensor
        humidity_high:
          name: 'Fan: humidity high threshold (%) (static)'
          description: Used when humidity_high_helper is not provided.
          default: 65
          selector:
            number:
              min: 0
              max: 100
              mode: slider
        humidity_low:
          name: 'Fan: humidity low threshold (%) (static)'
          description: Used when humidity_low_helper is not provided. (Hysteresis; should be lower than high.)
          default: 55
          selector:
            number:
              min: 0
              max: 100
              mode: slider
        humidity_high_helper:
          name: 'Fan: humidity high helper (optional input_number)'
          description: Optional. If set, overrides humidity_high at runtime.
          default: ''
          selector:
            entity:
              domain: input_number
        humidity_low_helper:
          name: 'Fan: humidity low helper (optional input_number)'
          description: Optional. If set, overrides humidity_low at runtime.
          default: ''
          selector:
            entity:
              domain: input_number
        humidity_check_interval:
          name: 'Fan: humidity re-check interval'
          description: How often to re-check humidity while holding the fan on.
          default: 00:02:00
          selector:
            duration: null
        humidity_hold_max:
          name: 'Fan: max humidity hold time'
          description: Maximum time to keep the fan running due to humidity after the off point.
          default: 01:00:00
          selector:
            duration: null

mode: restart
max_exceeded: silent

trigger:
  - platform: state
    entity_id: !input occupied_effective
    to: "on"
    for: !input on_debounce
    id: occupied_on

  - platform: state
    entity_id: !input occupied_effective
    to: "off"
    for: !input lights_off_delay
    id: lights_off

  - platform: state
    entity_id: !input occupied_effective
    to: "off"
    id: vacancy_began

  - platform: event
    event_type: timer.finished
    id: timer_finished

  - platform: homeassistant
    event: start
    id: ha_start

variables:
  occ: !input occupied_effective

  lights: !input lights
  lights_on_script: !input lights_on_script
  lights_off_script: !input lights_off_script

  lights_control_enabled: >-
    {{ (lights | length > 0) or (lights_on_script != '') or (lights_off_script != '') }}

  fan_entity: !input fan_entity
  fan_switches: !input fan_switches

  override_b: !input automation_override
  force_b: !input force_occupied
  manual_b: !input manual_occupied

  auto_tag_lights: !input auto_tag_lights
  auto_tag_fan: !input auto_tag_fan

  cooldown_t: !input cooldown_timer

  # Light gating
  turn_on_only_if_dark: !input turn_on_only_if_dark
  lux_entity: !input illuminance_entity
  use_lux_gate: !input use_illuminance_gate
  lux_threshold_static: !input illuminance_threshold
  lux_threshold_helper: !input illuminance_threshold_helper

  use_night_profile: !input use_night_profile
  night_start: !input night_start
  night_end: !input night_end

  brightness_day: !input brightness_day_pct
  brightness_night: !input brightness_night_pct

  # Fan timing and behavior
  fan_turn_on_on_occupy: !input fan_turn_on_on_occupy
  fan_on_delay_static: !input fan_on_delay
  fan_on_delay_seconds_helper: !input fan_on_delay_seconds_helper
  fan_turn_off_on_vacant: !input fan_turn_off_on_vacant
  fan_disable_during_night: !input fan_disable_during_night
  fan_runon_t: !input fan_runon_timer
  fan_runon_duration: !input fan_runon_duration
  fan_runon_after_lights: !input fan_runon_starts_after_lights_off

  # Humidity hold
  humidity_entity: !input humidity_entity
  humidity_high_static: !input humidity_high
  humidity_low_static: !input humidity_low
  humidity_high_helper: !input humidity_high_helper
  humidity_low_helper: !input humidity_low_helper
  humidity_check_interval: !input humidity_check_interval
  humidity_hold_max: !input humidity_hold_max

  fan_use_night_profile: !input fan_use_night_profile
  fan_pct_day: !input fan_percentage_day
  fan_pct_night: !input fan_percentage_night
  fan_preset_day: !input fan_preset_day
  fan_preset_night: !input fan_preset_night
  fan_skip_on_if_already_on: !input fan_skip_on_if_already_on

  startup_cleanup: !input startup_cleanup
  startup_cleanup_delay: !input startup_cleanup_delay

  skip_on_if_any_light_on: !input skip_on_if_any_light_on

  override_ok: >-
    {{ override_b == '' or is_state(override_b, 'off') }}

  force_ok: >-
    {{ force_b == '' or is_state(force_b, 'off') }}

  manual_ok: >-
    {{ manual_b == '' or is_state(manual_b, 'off') }}

  cooldown_active: >-
    {{ cooldown_t != '' and is_state(cooldown_t, 'active') }}

  is_dark: >-
    {{ is_state('sun.sun', 'below_horizon') }}

  is_night: >-
    {% set start = today_at(night_start) %}
    {% set end = today_at(night_end) %}
    {% if start <= end %}
      {{ start <= now() < end }}
    {% else %}
      {{ now() >= start or now() < end }}
    {% endif %}

  lux_value: >-
    {% if lux_entity != '' %}
      {{ states(lux_entity) | float(999999) }}
    {% else %}
      999999
    {% endif %}

  lux_threshold: >-
    {% if lux_threshold_helper != '' %}
      {{ states(lux_threshold_helper) | float(lux_threshold_static) }}
    {% else %}
      {{ lux_threshold_static | float }}
    {% endif %}

  lights_ok_to_turn_on: >-
    {% if lux_entity != '' and use_lux_gate %}
      {{ lux_value < lux_threshold }}
    {% else %}
      {{ (not turn_on_only_if_dark) or is_dark }}
    {% endif %}

  light_brightness_pct: >-
    {% if use_night_profile and is_night %}
      {{ brightness_night }}
    {% else %}
      {{ brightness_day }}
    {% endif %}

  fan_pct: >-
    {% if fan_use_night_profile and is_night %}
      {{ fan_pct_night }}
    {% else %}
      {{ fan_pct_day }}
    {% endif %}

  fan_preset: >-
    {% if fan_use_night_profile and is_night %}
      {{ fan_preset_night }}
    {% else %}
      {{ fan_preset_day }}
    {% endif %}

  fan_on_delay_seconds: >-
    {% if fan_on_delay_seconds_helper != '' %}
      {{ states(fan_on_delay_seconds_helper) | float(0) }}
    {% else %}
      {{ as_timedelta(fan_on_delay_static).total_seconds() }}
    {% endif %}

  any_light_on: >-
    {{ expand(lights) | selectattr('state','eq','on') | list | count > 0 }}

  fan_is_on: >-
    {{ fan_entity != '' and is_state(fan_entity, 'on') }}

  any_fan_switch_on: >-
    {{ (fan_switches | length > 0) and (expand(fan_switches) | selectattr('state','eq','on') | list | count > 0) }}

  fan_currently_on: >-
    {{ fan_is_on or any_fan_switch_on }}

  fan_runon_active: >-
    {{ fan_runon_t != '' and is_state(fan_runon_t, 'active') }}

  tag_lights_ok_to_off: >-
    {{ auto_tag_lights == '' or is_state(auto_tag_lights, 'on') }}

  tag_fan_ok_to_off: >-
    {{ auto_tag_fan == '' or is_state(auto_tag_fan, 'on') }}

  humidity_high: >-
    {% if humidity_high_helper != '' %}
      {{ states(humidity_high_helper) | float(humidity_high_static) }}
    {% else %}
      {{ humidity_high_static | float }}
    {% endif %}

  humidity_low: >-
    {% if humidity_low_helper != '' %}
      {{ states(humidity_low_helper) | float(humidity_low_static) }}
    {% else %}
      {{ humidity_low_static | float }}
    {% endif %}

  humidity_hold_enabled: >-
    {{ humidity_entity != '' and auto_tag_fan != '' and is_state(auto_tag_fan, 'on') }}

  humidity_hold_max_seconds: >-
    {{ as_timedelta(humidity_hold_max).total_seconds() }}

action:
  - choose:
      # ================= OCCUPIED -> ON =================
      - conditions:
          - condition: trigger
            id: occupied_on
          - condition: template
            value_template: "{{ override_ok }}"
          - condition: template
            value_template: "{{ not cooldown_active }}"
        sequence:
          # Cancel fan run-on timer if present (prevents timer turning fan off while occupied)
          - choose:
              - conditions:
                  - condition: template
                    value_template: "{{ fan_runon_t != '' }}"
                sequence:
                  - service: timer.cancel
                    target:
                      entity_id: "{{ fan_runon_t }}"

          # ---- Lights ON ----
          - choose:
              - conditions:
                  - condition: template
                    value_template: "{{ lights_control_enabled }}"
                  - condition: template
                    value_template: "{{ lights_ok_to_turn_on }}"
                  - condition: template
                    value_template: "{{ (not skip_on_if_any_light_on) or (not any_light_on) }}"
                sequence:
                  - choose:
                      - conditions:
                          - condition: template
                            value_template: "{{ lights_on_script != '' }}"
                        sequence:
                          - service: script.turn_on
                            target:
                              entity_id: "{{ lights_on_script }}"
                            data:
                              variables:
                                lights: !input lights
                                brightness_pct: "{{ light_brightness_pct }}"
                                transition: !input transition_on
                                is_night: "{{ is_night }}"
                                lux_value: "{{ lux_value }}"
                                lux_threshold: "{{ lux_threshold }}"
                                reason: occupied_on
                          - choose:
                              - conditions:
                                  - condition: template
                                    value_template: "{{ auto_tag_lights != '' }}"
                                sequence:
                                  - service: input_boolean.turn_on
                                    target:
                                      entity_id: "{{ auto_tag_lights }}"

                      - conditions:
                          - condition: template
                            value_template: "{{ (lights_on_script == '') and (lights | length > 0) }}"
                        sequence:
                          - service: light.turn_on
                            target:
                              entity_id: !input lights
                            data:
                              brightness_pct: "{{ light_brightness_pct }}"
                              transition: !input transition_on
                          - choose:
                              - conditions:
                                  - condition: template
                                    value_template: "{{ auto_tag_lights != '' }}"
                                sequence:
                                  - service: input_boolean.turn_on
                                    target:
                                      entity_id: "{{ auto_tag_lights }}"
          # ---- Fan ON (with optional delay) ----
          - choose:
              - conditions:
                  - condition: template
                    value_template: "{{ fan_turn_on_on_occupy }}"
                  - condition: template
                    value_template: "{{ (not fan_disable_during_night) or (not is_night) }}"
                sequence:
                  - choose:
                      - conditions:
                          - condition: template
                            value_template: "{{ fan_on_delay_seconds | float(0) > 0 }}"
                        sequence:
                          - delay:
                              seconds: "{{ fan_on_delay_seconds | int(0) }}"
                          - condition: template
                            value_template: "{{ is_state(occ, 'on') and override_ok }}"
                  - choose:
                      - conditions:
                          - condition: template
                            value_template: "{{ fan_entity != '' }}"
                          - condition: template
                            value_template: "{{ (not fan_skip_on_if_already_on) or (not fan_is_on) }}"
                        sequence:
                          - service: fan.turn_on
                            target:
                              entity_id: "{{ fan_entity }}"
                          - choose:
                              - conditions:
                                  - condition: template
                                    value_template: "{{ fan_pct | int > 0 }}"
                                sequence:
                                  - service: fan.set_percentage
                                    target:
                                      entity_id: "{{ fan_entity }}"
                                    data:
                                      percentage: "{{ fan_pct | int }}"
                          - choose:
                              - conditions:
                                  - condition: template
                                    value_template: "{{ fan_preset is string and fan_preset | length > 0 }}"
                                sequence:
                                  - service: fan.set_preset_mode
                                    target:
                                      entity_id: "{{ fan_entity }}"
                                    data:
                                      preset_mode: "{{ fan_preset }}"
                          - choose:
                              - conditions:
                                  - condition: template
                                    value_template: "{{ auto_tag_fan != '' }}"
                                sequence:
                                  - service: input_boolean.turn_on
                                    target:
                                      entity_id: "{{ auto_tag_fan }}"

                      - conditions:
                          - condition: template
                            value_template: "{{ (fan_entity == '') and (fan_switches | length > 0) }}"
                        sequence:
                          - service: switch.turn_on
                            target:
                              entity_id: !input fan_switches
                          - choose:
                              - conditions:
                                  - condition: template
                                    value_template: "{{ auto_tag_fan != '' }}"
                                sequence:
                                  - service: input_boolean.turn_on
                                    target:
                                      entity_id: "{{ auto_tag_fan }}"

          # ---- Cooldown timer ----
          - choose:
              - conditions:
                  - condition: template
                    value_template: "{{ cooldown_t != '' }}"
                sequence:
                  - service: timer.start
                    target:
                      entity_id: "{{ cooldown_t }}"
                    data:
                      duration: !input cooldown_duration

      # ================= VACANT -> LIGHTS OFF (+ start fan run-on if configured to start after lights) =================
      - conditions:
          - condition: trigger
            id: lights_off
          - condition: template
            value_template: "{{ override_ok }}"
          - condition: template
            value_template: "{{ force_ok and manual_ok }}"
        sequence:
          # Lights OFF
          - choose:
              - conditions:
                  - condition: template
                    value_template: "{{ lights_control_enabled and tag_lights_ok_to_off }}"
                sequence:
                  - choose:
                      - conditions:
                          - condition: template
                            value_template: "{{ lights_off_script != '' }}"
                        sequence:
                          - service: script.turn_on
                            target:
                              entity_id: "{{ lights_off_script }}"
                            data:
                              variables:
                                lights: !input lights
                                transition: !input transition_off
                                is_night: "{{ is_night }}"
                                lux_value: "{{ lux_value }}"
                                lux_threshold: "{{ lux_threshold }}"
                                reason: vacant_lights_off
                      - conditions:
                          - condition: template
                            value_template: "{{ (lights_off_script == '') and (lights | length > 0) }}"
                        sequence:
                          - service: light.turn_off
                            target:
                              entity_id: !input lights
                            data:
                              transition: !input transition_off
                  - choose:
                      - conditions:
                          - condition: template
                            value_template: "{{ auto_tag_lights != '' }}"
                        sequence:
                          - service: input_boolean.turn_off
                            target:
                              entity_id: "{{ auto_tag_lights }}"
          # Start fan run-on AFTER lights off (recommended behavior)
          - choose:
              - conditions:
                  - condition: template
                    value_template: "{{ fan_turn_off_on_vacant and fan_runon_t != '' and fan_runon_after_lights }}"
                  - condition: template
                    value_template: "{{ tag_fan_ok_to_off and fan_currently_on }}"
                sequence:
                  - service: timer.start
                    target:
                      entity_id: "{{ fan_runon_t }}"
                    data:
                      duration: !input fan_runon_duration

          # Fallback: no fan timer -> fan off with lights_off point (humidity hold may extend)
          - choose:
              - conditions:
                  - condition: template
                    value_template: "{{ fan_turn_off_on_vacant and tag_fan_ok_to_off and fan_runon_t == '' }}"
                sequence:
                  - variables:
                      hold_start: "{{ now() }}"
                  - choose:
                      - conditions:
                          - condition: template
                            value_template: "{{ humidity_hold_enabled and (states(humidity_entity)|float(0)) >= humidity_high }}"
                        sequence:
                          - repeat:
                              while:
                                - condition: template
                                  value_template: "{{ is_state(occ,'off') and override_ok and force_ok and manual_ok }}"
                                - condition: template
                                  value_template: "{{ (states(humidity_entity)|float(0)) > humidity_low }}"
                                - condition: template
                                  value_template: "{{ (now() - hold_start).total_seconds() < humidity_hold_max_seconds }}"
                              sequence:
                                - delay: !input humidity_check_interval
                  - choose:
                      - conditions:
                          - condition: template
                            value_template: "{{ fan_entity != '' }}"
                        sequence:
                          - service: fan.turn_off
                            target:
                              entity_id: "{{ fan_entity }}"
                      - conditions:
                          - condition: template
                            value_template: "{{ (fan_entity == '') and (fan_switches | length > 0) }}"
                        sequence:
                          - service: switch.turn_off
                            target:
                              entity_id: !input fan_switches
                  - choose:
                      - conditions:
                          - condition: template
                            value_template: "{{ auto_tag_fan != '' }}"
                        sequence:
                          - service: input_boolean.turn_off
                            target:
                              entity_id: "{{ auto_tag_fan }}"

      # ================= VACANT -> START FAN RUN-ON (if configured to start immediately) =================
      - conditions:
          - condition: trigger
            id: vacancy_began
          - condition: template
            value_template: "{{ override_ok }}"
          - condition: template
            value_template: "{{ fan_turn_off_on_vacant }}"
          - condition: template
            value_template: "{{ fan_runon_t != '' }}"
          - condition: template
            value_template: "{{ not fan_runon_after_lights }}"
          - condition: template
            value_template: "{{ tag_fan_ok_to_off }}"
          - condition: template
            value_template: "{{ fan_currently_on }}"
        sequence:
          - service: timer.start
            target:
              entity_id: "{{ fan_runon_t }}"
            data:
              duration: !input fan_runon_duration

      # ================= FAN RUN-ON DONE -> FAN OFF (humidity hold may extend) =================
      - conditions:
          - condition: trigger
            id: timer_finished
          - condition: template
            value_template: "{{ fan_runon_t != '' and trigger.event.data.entity_id == fan_runon_t }}"
          - condition: template
            value_template: "{{ override_ok }}"
          - condition: template
            value_template: "{{ fan_turn_off_on_vacant and tag_fan_ok_to_off }}"
          - condition: template
            value_template: "{{ is_state(occ, 'off') }}"
          - condition: template
            value_template: "{{ force_ok and manual_ok }}"
        sequence:
          - variables:
              hold_start: "{{ now() }}"
          - choose:
              - conditions:
                  - condition: template
                    value_template: "{{ humidity_hold_enabled and (states(humidity_entity)|float(0)) >= humidity_high }}"
                sequence:
                  - repeat:
                      while:
                        - condition: template
                          value_template: "{{ is_state(occ,'off') and override_ok and force_ok and manual_ok }}"
                        - condition: template
                          value_template: "{{ (states(humidity_entity)|float(0)) > humidity_low }}"
                        - condition: template
                          value_template: "{{ (now() - hold_start).total_seconds() < humidity_hold_max_seconds }}"
                      sequence:
                        - delay: !input humidity_check_interval

          - choose:
              - conditions:
                  - condition: template
                    value_template: "{{ fan_entity != '' }}"
                sequence:
                  - service: fan.turn_off
                    target:
                      entity_id: "{{ fan_entity }}"
              - conditions:
                  - condition: template
                    value_template: "{{ (fan_entity == '') and (fan_switches | length > 0) }}"
                sequence:
                  - service: switch.turn_off
                    target:
                      entity_id: !input fan_switches
          - choose:
              - conditions:
                  - condition: template
                    value_template: "{{ auto_tag_fan != '' }}"
                sequence:
                  - service: input_boolean.turn_off
                    target:
                      entity_id: "{{ auto_tag_fan }}"

      # ================= STARTUP CLEANUP =================
      - conditions:
          - condition: trigger
            id: ha_start
          - condition: template
            value_template: "{{ startup_cleanup }}"
        sequence:
          - delay: !input startup_cleanup_delay
          - condition: template
            value_template: "{{ override_ok }}"
          - condition: template
            value_template: "{{ force_ok and manual_ok }}"
          - condition: template
            value_template: "{{ is_state(occ, 'off') }}"

          - choose:
              - conditions:
                  - condition: template
                    value_template: >-
                      {{ auto_tag_lights != '' and is_state(auto_tag_lights,'on') and (any_light_on or (lights_off_script != '') or (lights | length > 0)) }}
                sequence:
                  - choose:
                      - conditions:
                          - condition: template
                            value_template: "{{ lights_off_script != '' }}"
                        sequence:
                          - service: script.turn_on
                            target:
                              entity_id: "{{ lights_off_script }}"
                            data:
                              variables:
                                lights: !input lights
                                transition: !input transition_off
                                is_night: "{{ is_night }}"
                                lux_value: "{{ lux_value }}"
                                lux_threshold: "{{ lux_threshold }}"
                                reason: startup_cleanup
                      - conditions:
                          - condition: template
                            value_template: "{{ (lights_off_script == '') and (lights | length > 0) }}"
                        sequence:
                          - service: light.turn_off
                            target:
                              entity_id: !input lights
                            data:
                              transition: !input transition_off
                  - service: input_boolean.turn_off
                    target:
                      entity_id: "{{ auto_tag_lights }}"
          - choose:
              - conditions:
                  - condition: template
                    value_template: "{{ auto_tag_fan != '' and is_state(auto_tag_fan,'on') and fan_currently_on and (not fan_runon_active) }}"
                sequence:
                  - choose:
                      - conditions:
                          - condition: template
                            value_template: "{{ fan_entity != '' }}"
                        sequence:
                          - service: fan.turn_off
                            target:
                              entity_id: "{{ fan_entity }}"
                      - conditions:
                          - condition: template
                            value_template: "{{ (fan_entity == '') and (fan_switches | length > 0) }}"
                        sequence:
                          - service: switch.turn_off
                            target:
                              entity_id: !input fan_switches
                  - service: input_boolean.turn_off
                    target:
                      entity_id: "{{ auto_tag_fan }}"
