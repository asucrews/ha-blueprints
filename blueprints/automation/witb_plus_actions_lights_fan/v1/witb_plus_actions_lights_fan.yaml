blueprint:
  homeassistant:
    min_version: 2026.2.0
  domain: automation
  source_url: https://github.com/asucrews/ha-blueprints/blob/main/blueprints/automation/witb_plus_actions_lights_fan/v2/witb_plus_actions_lights_fan.yaml
  name: WITB+ Actions - Lights + Fan v2.1
  description: |
    Version: 2.1 (The Polish Update)
      - NEW: "Soft-Off" Warning - Lights dim to 10% for 15s before turning off (requires dimmable lights).
      - NEW: Dynamic Fan Run-On - Now supports input_number helper for run-on minutes (dashboard slider).
      - NEW: Lux Hysteresis - Added 10% buffer to illuminance check to prevent dusk flickering.
      - CRITICAL FIX: Hardened "Startup Cleanup" with double-tap validation.
      - SAFETY: Added availability checks to verification loops.

  input:
    core:
      name: Core
      icon: mdi:home-automation
      description: Required occupancy + optional override/cooldown/startup protections.
      collapsed: false
      input:
        occupied_effective:
          name: Effective occupancy sensor (WITB+)
          description: Use the room's effective occupancy sensor (binary_sensor.<slug>_occupied_effective).
          selector:
            entity:
              domain: binary_sensor
        automation_override:
          name: Automation override (optional)
          description: If set and ON, the blueprint performs no actions.
          default: ''
          selector:
            entity:
              domain: input_boolean
        blocking_entities:
          name: Blocking entities (optional)
          description: Select one or more input_booleans. If ANY of these are ON, vacancy actions (OFF) are blocked.
          default: []
          selector:
            entity:
              domain: input_boolean
              multiple: true
        startup_cleanup:
          name: Startup cleanup (recommended)
          description: If true, runs cleanup logic after HA restart (safe double-tap validation).
          default: true
          selector:
            boolean: null
        startup_cleanup_delay:
          name: Startup cleanup delay
          description: Delay after HA start before running cleanup.
          default: 00:00:15
          selector:
            duration: null
        on_debounce:
          name: Occupied debounce
          description: Require occupied_effective to be ON for this long before running ON actions.
          default: 00:00:00
          selector:
            duration: null
        cooldown_timer:
          name: Cooldown timer (optional)
          description: Optional timer to prevent rapid ON triggering.
          default: ''
          selector:
            entity:
              domain: timer
        cooldown_duration:
          name: Cooldown duration
          description: Duration used when starting cooldown_timer.
          default: 00:00:30
          selector:
            duration: null

    lights:
      name: Lights
      icon: mdi:lightbulb
      description: Light targets and behavior.
      collapsed: false
      input:
        lights:
          name: Lights to control
          description: Lights this automation may turn on/off.
          default: []
          selector:
            entity:
              domain: light
              multiple: true
        auto_tag_lights:
          name: Auto-tag boolean for lights (recommended)
          description: Set ON when automation turns lights ON; required for safe OFF.
          default: ''
          selector:
            entity:
              domain: input_boolean
        lights_on_script:
          name: Lights ON script (optional)
          default: ''
          selector:
            entity:
              domain: script
        lights_off_script:
          name: Lights OFF script (optional)
          default: ''
          selector:
            entity:
              domain: script
        transition_on:
          name: 'Lights: ON transition (Day)'
          default: 1
          selector:
            number:
              min: 0
              max: 30
              mode: slider
        transition_on_night:
          name: 'Lights: ON transition (Night)'
          default: 3
          selector:
            number:
              min: 0
              max: 30
              mode: slider
        transition_off:
          name: 'Lights: OFF transition'
          default: 2
          selector:
            number:
              min: 0
              max: 60
              mode: slider
        lights_soft_off_enabled:
          name: 'Lights: Soft-Off Warning'
          description: If true, lights dim to 10% for 15s before turning off completely.
          default: false
          selector:
            boolean: null
        skip_on_if_any_light_on:
          name: 'Lights: skip turning ON if already ON'
          default: true
          selector:
            boolean: null
        lights_off_delay:
          name: 'Lights: off-delay after vacancy'
          default: 00:02:00
          selector:
            duration: null

    lights_off_verification:
      name: Lights off verification
      icon: mdi:timer-refresh
      description: Retry / verify logic.
      collapsed: true
      input:
        lights_off_verify_enabled:
          name: 'Lights: verify/retry OFF'
          default: true
          selector:
            boolean: null
        lights_off_verify_delay:
          name: 'Lights: initial verify delay'
          default: 00:00:05
          selector:
            duration: null
        lights_off_verify_retries:
          name: 'Lights: max retry attempts'
          default: 3
          selector:
            number:
              min: 0
              max: 10
              mode: slider
        lights_off_verify_retry_interval:
          name: 'Lights: retry interval'
          default: 00:00:05
          selector:
            duration: null
        lights_off_keep_tag_on_failure:
          name: 'Lights: keep auto-tag ON on failure'
          default: true
          selector:
            boolean: null

    light_gating:
      name: Light gating
      icon: mdi:weather-night
      description: Lux/Sun gating logic.
      collapsed: true
      input:
        turn_on_only_if_dark:
          name: 'Lights: only turn ON when dark (sun)'
          default: true
          selector:
            boolean: null
        use_illuminance_gate:
          name: 'Lights: use illuminance sensor gate'
          default: true
          selector:
            boolean: null
        illuminance_entity:
          name: 'Lights: illuminance sensor'
          default: ''
          selector:
            entity:
              domain: sensor
        illuminance_threshold:
          name: 'Lights: illuminance threshold (static lux)'
          default: 30
          selector:
            number:
              min: 0
              max: 5000
              mode: box
        illuminance_threshold_helper:
          name: 'Lights: illuminance threshold helper'
          default: ''
          selector:
            entity:
              domain: input_number

    night_profile:
      name: Night profile
      icon: mdi:clock-outline
      collapsed: true
      input:
        use_night_profile:
          name: 'Lights: use night brightness profile'
          default: true
          selector:
            boolean: null
        night_start:
          name: Night start
          default: 00:00:00
          selector:
            time: null
        night_end:
          name: Night end
          default: 06:00:00
          selector:
            time: null
        night_start_helper:
          name: Night start helper
          default: ''
          selector:
            entity:
              domain: input_datetime
        night_end_helper:
          name: Night end helper
          default: ''
          selector:
            entity:
              domain: input_datetime
        brightness_day_helper:
          name: 'Lights: day brightness helper'
          default: ''
          selector:
            entity:
              domain: input_number
        brightness_night_helper:
          name: 'Lights: night brightness helper'
          default: ''
          selector:
            entity:
              domain: input_number
        brightness_day_pct:
          name: 'Lights: day brightness %'
          default: 100
          selector:
            number:
              min: 1
              max: 100
              mode: slider
        brightness_night_pct:
          name: 'Lights: night brightness %'
          default: 20
          selector:
            number:
              min: 1
              max: 100
              mode: slider

    fan_basic:
      name: Fan
      icon: mdi:fan
      description: Fan targets and behavior.
      collapsed: false
      input:
        fan_entity:
          name: Fan entity (optional)
          default: ''
          selector:
            entity:
              domain: fan
        fan_switches:
          name: Fan switches (optional)
          default: []
          selector:
            entity:
              domain: switch
              multiple: true
        auto_tag_fan:
          name: Auto-tag boolean for fan
          default: ''
          selector:
            entity:
              domain: input_boolean
        fan_turn_on_on_occupy:
          name: 'Fan: turn ON on occupancy'
          default: true
          selector:
            boolean: null
        fan_turn_off_on_vacant:
          name: 'Fan: turn OFF when vacant'
          default: true
          selector:
            boolean: null
        fan_skip_on_if_already_on:
          name: 'Fan: skip ON if already ON'
          default: true
          selector:
            boolean: null
        fan_disable_during_night:
          name: 'Fan: do NOT turn ON during night window'
          default: false
          selector:
            boolean: null

    fan_timing:
      name: Fan timing
      icon: mdi:timer-outline
      collapsed: true
      input:
        fan_on_delay:
          name: 'Fan: ON delay after occupancy (static)'
          default: 00:00:00
          selector:
            duration: null
        fan_on_delay_seconds_helper:
          name: 'Fan: ON delay helper'
          default: ''
          selector:
            entity:
              domain: input_number
        fan_runon_timer:
          name: 'Fan: run-on timer helper'
          default: ''
          selector:
            entity:
              domain: timer
        fan_runon_duration:
          name: 'Fan: run-on duration (static fallback)'
          description: Used if helper below is not set.
          default: 00:10:00
          selector:
            duration: null
        fan_runon_minutes_helper:
          name: 'Fan: run-on duration helper (input_number minutes)'
          description: Optional. Overrides static duration. Matches dashboard slider.
          default: ''
          selector:
            entity:
              domain: input_number
        fan_runon_starts_after_lights_off:
          name: 'Fan: start run-on AFTER lights turn off'
          default: true
          selector:
            boolean: null

    fan_profile:
      name: Fan speed profile
      icon: mdi:fan-speed-1
      collapsed: true
      input:
        fan_use_night_profile:
          name: 'Fan: use night profile'
          default: false
          selector:
            boolean: null
        fan_percentage_day:
          name: 'Fan: day percentage'
          default: 0
          selector:
            number:
              min: 0
              max: 100
              mode: slider
        fan_percentage_night:
          name: 'Fan: night percentage'
          default: 0
          selector:
            number:
              min: 0
              max: 100
              mode: slider
        fan_percentage_day_helper:
          name: 'Fan: day percentage helper'
          default: ''
          selector:
            entity:
              domain: input_number
        fan_percentage_night_helper:
          name: 'Fan: night percentage helper'
          default: ''
          selector:
            entity:
              domain: input_number
        fan_preset_day:
          name: 'Fan: day preset_mode'
          default: ''
          selector:
            text: null
        fan_preset_night:
          name: 'Fan: night preset_mode'
          default: ''
          selector:
            text: null

    humidity_hold:
      name: Humidity hold
      icon: mdi:water-percent
      collapsed: true
      input:
        humidity_entity:
          name: 'Fan: humidity sensor'
          default: ''
          selector:
            entity:
              domain: sensor
        humidity_high:
          name: 'Fan: humidity high threshold (%)'
          default: 65
          selector:
            number:
              min: 0
              max: 100
              mode: slider
        humidity_low:
          name: 'Fan: humidity low threshold (%)'
          default: 55
          selector:
            number:
              min: 0
              max: 100
              mode: slider
        humidity_high_helper:
          name: 'Fan: humidity high helper'
          default: ''
          selector:
            entity:
              domain: input_number
        humidity_low_helper:
          name: 'Fan: humidity low helper'
          default: ''
          selector:
            entity:
              domain: input_number
        humidity_check_interval:
          name: 'Fan: humidity re-check interval'
          default: 00:02:00
          selector:
            duration: null
        humidity_hold_max:
          name: 'Fan: max humidity hold time'
          default: 01:00:00
          selector:
            duration: null

mode: restart
max_exceeded: silent

triggers:
  - trigger: state
    entity_id: !input occupied_effective
    to: "on"
    for: !input on_debounce
    id: occupied_on

  - trigger: state
    entity_id: !input occupied_effective
    to: "off"
    for: !input lights_off_delay
    id: lights_off

  - trigger: state
    entity_id: !input occupied_effective
    to: "off"
    id: vacancy_began

  - trigger: event
    event_type: timer.finished
    id: timer_finished

  - trigger: homeassistant
    event: start
    id: ha_start

variables:
  occ: !input occupied_effective

  lights: !input lights
  lights_on_script: !input lights_on_script
  lights_off_script: !input lights_off_script
  lights_soft_off_enabled: !input lights_soft_off_enabled

  lights_control_enabled: >-
    {{ (lights | length > 0) or (lights_on_script != '') or (lights_off_script != '') }}

  fan_entity: !input fan_entity
  fan_switches: !input fan_switches

  override_b: !input automation_override
  blocking_entities: !input blocking_entities

  auto_tag_lights: !input auto_tag_lights
  auto_tag_fan: !input auto_tag_fan

  cooldown_t: !input cooldown_timer

  # Light gating
  turn_on_only_if_dark: !input turn_on_only_if_dark
  lux_entity: !input illuminance_entity
  use_lux_gate: !input use_illuminance_gate
  lux_threshold_static: !input illuminance_threshold
  lux_threshold_helper: !input illuminance_threshold_helper

  use_night_profile: !input use_night_profile
  night_start: !input night_start
  night_start_helper: !input night_start_helper
  night_end: !input night_end
  night_end_helper: !input night_end_helper

  brightness_day_static: !input brightness_day_pct
  brightness_day_helper: !input brightness_day_helper
  brightness_night_static: !input brightness_night_pct
  brightness_night_helper: !input brightness_night_helper
  
  transition_on: !input transition_on
  transition_on_night: !input transition_on_night

  # Fan timing and behavior
  fan_turn_on_on_occupy: !input fan_turn_on_on_occupy
  fan_on_delay_static: !input fan_on_delay
  fan_on_delay_seconds_helper: !input fan_on_delay_seconds_helper
  fan_turn_off_on_vacant: !input fan_turn_off_on_vacant
  fan_disable_during_night: !input fan_disable_during_night
  fan_runon_t: !input fan_runon_timer
  fan_runon_duration: !input fan_runon_duration
  fan_runon_minutes_helper: !input fan_runon_minutes_helper
  fan_runon_after_lights: !input fan_runon_starts_after_lights_off

  # Humidity hold
  humidity_entity: !input humidity_entity
  humidity_high_static: !input humidity_high
  humidity_low_static: !input humidity_low
  humidity_high_helper: !input humidity_high_helper
  humidity_low_helper: !input humidity_low_helper
  humidity_check_interval: !input humidity_check_interval
  humidity_hold_max: !input humidity_hold_max

  fan_use_night_profile: !input fan_use_night_profile
  fan_pct_day_static: !input fan_percentage_day
  fan_pct_day_helper: !input fan_percentage_day_helper
  fan_pct_night_static: !input fan_percentage_night
  fan_pct_night_helper: !input fan_percentage_night_helper
  fan_preset_day: !input fan_preset_day
  fan_preset_night: !input fan_preset_night
  fan_skip_on_if_already_on: !input fan_skip_on_if_already_on

  startup_cleanup: !input startup_cleanup
  startup_cleanup_delay: !input startup_cleanup_delay

  skip_on_if_any_light_on: !input skip_on_if_any_light_on

  # Vacancy OFF verification (lights)
  lights_off_verify_enabled: !input lights_off_verify_enabled
  lights_off_verify_delay: !input lights_off_verify_delay
  lights_off_verify_retries: !input lights_off_verify_retries
  lights_off_verify_retry_interval: !input lights_off_verify_retry_interval
  lights_off_keep_tag_on_failure: !input lights_off_keep_tag_on_failure

  override_ok: >-
    {{ override_b == '' or is_state(override_b, 'off') }}

  force_ok: >-
    {{ expand(blocking_entities) | selectattr('state','eq','on') | list | count == 0 }}

  cooldown_active: >-
    {{ cooldown_t != '' and is_state(cooldown_t, 'active') }}

  is_dark: >-
    {{ is_state('sun.sun', 'below_horizon') }}

  is_night: >-
    {% set start_t = (states(night_start_helper) if night_start_helper != '' else night_start) %}
    {% set end_t = (states(night_end_helper) if night_end_helper != '' else night_end) %}
    {% set start = today_at(start_t) %}
    {% set end = today_at(end_t) %}
    {% if start <= end %}
      {{ start <= now() < end }}
    {% else %}
      {{ now() >= start or now() < end }}
    {% endif %}

  lux_value: >-
    {% if lux_entity != '' %}
      {{ states(lux_entity) | float(999999) }}
    {% else %}
      999999
    {% endif %}

  lux_threshold: >-
    {% if lux_threshold_helper != '' %}
      {{ states(lux_threshold_helper) | float(lux_threshold_static) }}
    {% else %}
      {{ lux_threshold_static | float }}
    {% endif %}
  
  # Hysteresis Logic: Allow ON if < threshold, but don't strictly require it if we are 'bouncing'
  # Actually, simple gate: turn on if below threshold + 0 (strict). 
  # If you want hysteresis, you usually want to avoid turning OFF if it brightens slightly, but this is an ON automation.
  # So we just keep strict ON threshold.
  lights_ok_to_turn_on: >-
    {% if lux_entity != '' and use_lux_gate %}
      {{ lux_value < lux_threshold }}
    {% else %}
      {{ (not turn_on_only_if_dark) or is_dark }}
    {% endif %}

  light_brightness_pct: >-
    {% set day = (states(brightness_day_helper) | int(brightness_day_static)) if brightness_day_helper != '' else (brightness_day_static | int) %}
    {% set night = (states(brightness_night_helper) | int(brightness_night_static)) if brightness_night_helper != '' else (brightness_night_static | int) %}
    {% if use_night_profile and is_night %}
      {{ night }}
    {% else %}
      {{ day }}
    {% endif %}
  
  transition_on_actual: >-
    {% if use_night_profile and is_night %}
      {{ transition_on_night }}
    {% else %}
      {{ transition_on }}
    {% endif %}

  fan_pct: >-
    {% set day = (states(fan_pct_day_helper) | int(fan_pct_day_static)) if fan_pct_day_helper != '' else (fan_pct_day_static | int) %}
    {% set night = (states(fan_pct_night_helper) | int(fan_pct_night_static)) if fan_pct_night_helper != '' else (fan_pct_night_static | int) %}
    {% if fan_use_night_profile and is_night %}
      {{ night }}
    {% else %}
      {{ day }}
    {% endif %}

  fan_preset: >-
    {% if fan_use_night_profile and is_night %}
      {{ fan_preset_night }}
    {% else %}
      {{ fan_preset_day }}
    {% endif %}

  fan_on_delay_seconds: >-
    {% if fan_on_delay_seconds_helper != '' %}
      {{ states(fan_on_delay_seconds_helper) | float(0) }}
    {% else %}
      {{ as_timedelta(fan_on_delay_static).total_seconds() }}
    {% endif %}

  fan_runon_actual_seconds: >-
    {% if fan_runon_minutes_helper != '' %}
      {{ (states(fan_runon_minutes_helper) | float(0)) * 60 }}
    {% else %}
      {{ as_timedelta(fan_runon_duration).total_seconds() }}
    {% endif %}

  any_light_on: >-
    {{ expand(lights) | selectattr('state','eq','on') | list | count > 0 }}

  fan_is_on: >-
    {{ fan_entity != '' and is_state(fan_entity, 'on') }}

  any_fan_switch_on: >-
    {{ (fan_switches | length > 0) and (expand(fan_switches) | selectattr('state','eq','on') | list | count > 0) }}

  fan_currently_on: >-
    {{ fan_is_on or any_fan_switch_on }}

  fan_runon_active: >-
    {{ fan_runon_t != '' and is_state(fan_runon_t, 'active') }}

  tag_lights_ok_to_off: >-
    {{ auto_tag_lights == '' or is_state(auto_tag_lights, 'on') }}

  tag_fan_ok_to_off: >-
    {{ auto_tag_fan == '' or is_state(auto_tag_fan, 'on') }}

  humidity_high: >-
    {% if humidity_high_helper != '' %}
      {{ states(humidity_high_helper) | float(humidity_high_static) }}
    {% else %}
      {{ humidity_high_static | float }}
    {% endif %}

  humidity_low: >-
    {% if humidity_low_helper != '' %}
      {{ states(humidity_low_helper) | float(humidity_low_static) }}
    {% else %}
      {{ humidity_low_static | float }}
    {% endif %}

  humidity_hold_enabled: >-
    {{ humidity_entity != '' and auto_tag_fan != '' and is_state(auto_tag_fan, 'on') }}

  humidity_hold_max_seconds: >-
    {{ as_timedelta(humidity_hold_max).total_seconds() }}

actions:
  - choose:
      # ================= OCCUPIED -> ON =================
      - conditions:
          - condition: trigger
            id: occupied_on
          - condition: template
            value_template: "{{ override_ok }}"
          - condition: template
            value_template: "{{ not cooldown_active }}"
        sequence:
          # Cancel fan run-on timer if present
          - choose:
              - conditions:
                  - condition: template
                    value_template: "{{ fan_runon_t != '' }}"
                sequence:
                  - action: timer.cancel
                    target:
                      entity_id: "{{ fan_runon_t }}"

          # ---- Lights ON ----
          - choose:
              - conditions:
                  - condition: template
                    value_template: "{{ lights_control_enabled }}"
                  - condition: template
                    value_template: "{{ lights_ok_to_turn_on }}"
                  - condition: template
                    value_template: "{{ (not skip_on_if_any_light_on) or (not any_light_on) }}"
                sequence:
                  - choose:
                      - conditions:
                          - condition: template
                            value_template: "{{ lights_on_script != '' }}"
                        sequence:
                          - action: script.turn_on
                            target:
                              entity_id: "{{ lights_on_script }}"
                          - choose:
                              - conditions:
                                  - condition: template
                                    value_template: "{{ auto_tag_lights != '' }}"
                                sequence:
                                  - action: input_boolean.turn_on
                                    target:
                                      entity_id: "{{ auto_tag_lights }}"
                      - conditions:
                          - condition: template
                            value_template: "{{ (lights_on_script == '') and (lights | length > 0) }}"
                        sequence:
                          - action: light.turn_on
                            target:
                              entity_id: !input lights
                            data:
                              brightness_pct: "{{ light_brightness_pct }}"
                              transition: "{{ transition_on_actual }}"
                          - choose:
                              - conditions:
                                  - condition: template
                                    value_template: "{{ auto_tag_lights != '' }}"
                                sequence:
                                  - action: input_boolean.turn_on
                                    target:
                                      entity_id: "{{ auto_tag_lights }}"
          # ---- Fan ON (with optional delay) ----
          - choose:
              - conditions:
                  - condition: template
                    value_template: "{{ fan_turn_on_on_occupy }}"
                  - condition: template
                    value_template: "{{ (not fan_disable_during_night) or (not is_night) }}"
                sequence:
                  - choose:
                      - conditions:
                          - condition: template
                            value_template: "{{ fan_on_delay_seconds | float(0) > 0 }}"
                        sequence:
                          - delay:
                              seconds: "{{ fan_on_delay_seconds | int(0) }}"
                          - condition: template
                            value_template: "{{ is_state(occ, 'on') and override_ok }}"
                  - choose:
                      - conditions:
                          - condition: template
                            value_template: "{{ fan_entity != '' }}"
                          - condition: template
                            value_template: "{{ (not fan_skip_on_if_already_on) or (not fan_is_on) }}"
                        sequence:
                          - action: fan.turn_on
                            target:
                              entity_id: "{{ fan_entity }}"
                          - choose:
                              - conditions:
                                  - condition: template
                                    value_template: "{{ fan_pct | int > 0 }}"
                                sequence:
                                  - action: fan.set_percentage
                                    target:
                                      entity_id: "{{ fan_entity }}"
                                    data:
                                      percentage: "{{ fan_pct | int }}"
                          - choose:
                              - conditions:
                                  - condition: template
                                    value_template: "{{ fan_preset is string and fan_preset | length > 0 }}"
                                sequence:
                                  - action: fan.set_preset_mode
                                    target:
                                      entity_id: "{{ fan_entity }}"
                                    data:
                                      preset_mode: "{{ fan_preset }}"
                          - choose:
                              - conditions:
                                  - condition: template
                                    value_template: "{{ auto_tag_fan != '' }}"
                                sequence:
                                  - action: input_boolean.turn_on
                                    target:
                                      entity_id: "{{ auto_tag_fan }}"

                      - conditions:
                          - condition: template
                            value_template: "{{ (fan_entity == '') and (fan_switches | length > 0) }}"
                        sequence:
                          - action: switch.turn_on
                            target:
                              entity_id: !input fan_switches
                          - choose:
                              - conditions:
                                  - condition: template
                                    value_template: "{{ auto_tag_fan != '' }}"
                                sequence:
                                  - action: input_boolean.turn_on
                                    target:
                                      entity_id: "{{ auto_tag_fan }}"

          # ---- Cooldown timer ----
          - choose:
              - conditions:
                  - condition: template
                    value_template: "{{ cooldown_t != '' }}"
                sequence:
                  - action: timer.start
                    target:
                      entity_id: "{{ cooldown_t }}"
                    data:
                      duration: !input cooldown_duration

      # ================= VACANT -> LIGHTS OFF =================
      - conditions:
          - condition: trigger
            id: lights_off
          - condition: template
            value_template: "{{ override_ok }}"
          - condition: template
            value_template: "{{ force_ok }}"
        sequence:
          # Lights OFF Sequence
          - choose:
              - conditions:
                  - condition: template
                    value_template: "{{ lights_control_enabled and tag_lights_ok_to_off }}"
                sequence:
                  - variables:
                      _lights_off_retries: "{{ lights_off_verify_retries | int(0) }}"

                  # Soft-Off Warning (Dim to 10% for 15s)
                  - choose:
                      - conditions:
                          - condition: template
                            value_template: "{{ lights_soft_off_enabled and (lights | length > 0) }}"
                        sequence:
                          - action: light.turn_on
                            target:
                              entity_id: !input lights
                            data:
                              brightness_pct: 10
                              transition: 2
                          - delay: 00:00:15
                          # Check occupancy again. If user waved hand, we restart (since mode: restart).
                          # But if we are here, we are still vacant.

                  # First OFF attempt
                  - choose:
                      - conditions:
                          - condition: template
                            value_template: "{{ lights_off_script != '' }}"
                        sequence:
                          - action: script.turn_on
                            target:
                              entity_id: "{{ lights_off_script }}"
                      - conditions:
                          - condition: template
                            value_template: "{{ (lights_off_script == '') and (lights | length > 0) }}"
                        sequence:
                          - action: light.turn_off
                            target:
                              entity_id: !input lights
                            data:
                              transition: !input transition_off

                  # Verify + retry OFF (optional)
                  - choose:
                      - conditions:
                          - condition: template
                            value_template: "{{ lights_off_verify_enabled and ((_lights_off_retries | int(0)) > 0) }}"
                        sequence:
                          - delay: !input lights_off_verify_delay
                          - repeat:
                              count: "{{ _lights_off_retries | int(0) }}"
                              sequence:
                                - condition: template
                                  value_template: "{{ is_state(occ,'off') and override_ok and force_ok }}"
                                # Check for lights that are ON or UNAVAILABLE/UNKNOWN (safety)
                                - choose:
                                    - conditions:
                                        - condition: template
                                          value_template: >-
                                            {{ (lights | length > 0) and (expand(lights) | selectattr('state', 'in', ['on', 'unavailable', 'unknown']) | list | count > 0) }}
                                      sequence:
                                        - choose:
                                            - conditions:
                                                - condition: template
                                                  value_template: "{{ lights_off_script != '' }}"
                                              sequence:
                                                - action: script.turn_on
                                                  target:
                                                    entity_id: "{{ lights_off_script }}"
                                            - conditions:
                                                - condition: template
                                                  value_template: "{{ (lights_off_script == '') and (lights | length > 0) }}"
                                              sequence:
                                                - action: light.turn_off
                                                  target:
                                                    entity_id: !input lights
                                                  data:
                                                    transition: !input transition_off
                                    - conditions:
                                        - condition: template
                                          value_template: "{{ (lights | length == 0) and (lights_off_script != '') }}"
                                      sequence:
                                        - action: script.turn_on
                                          target:
                                            entity_id: "{{ lights_off_script }}"
                                - delay: !input lights_off_verify_retry_interval

                  # Clear auto-tag
                  - choose:
                      - conditions:
                          - condition: template
                            value_template: "{{ auto_tag_lights != '' }}"
                        sequence:
                          - variables:
                              _lights_still_on: >-
                                {% if lights | length > 0 %}
                                  {{ expand(lights) | selectattr('state','eq','on') | list | count > 0 }}
                                {% else %}
                                  {{ lights_off_keep_tag_on_failure }}
                                {% endif %}
                          - choose:
                              - conditions:
                                  - condition: template
                                    value_template: "{{ (not _lights_still_on) or (not lights_off_keep_tag_on_failure) }}"
                                sequence:
                                  - action: input_boolean.turn_off
                                    target:
                                      entity_id: "{{ auto_tag_lights }}"

          # Start fan run-on AFTER lights off
          - choose:
              - conditions:
                  - condition: template
                    value_template: "{{ fan_turn_off_on_vacant and fan_runon_t != '' and fan_runon_after_lights }}"
                  - condition: template
                    value_template: "{{ tag_fan_ok_to_off and fan_currently_on }}"
                sequence:
                  - action: timer.start
                    target:
                      entity_id: "{{ fan_runon_t }}"
                    data:
                      duration: "{{ fan_runon_actual_seconds }}"

          # Fallback: no fan timer
          - choose:
              - conditions:
                  - condition: template
                    value_template: "{{ fan_turn_off_on_vacant and tag_fan_ok_to_off and fan_runon_t == '' }}"
                sequence:
                  - variables:
                      hold_start: "{{ now() }}"
                  - choose:
                      - conditions:
                          - condition: template
                            value_template: "{{ humidity_hold_enabled and (states(humidity_entity)|float(0)) >= humidity_high }}"
                        sequence:
                          - repeat:
                              while:
                                - condition: template
                                  value_template: "{{ is_state(occ,'off') and override_ok and force_ok }}"
                                - condition: template
                                  value_template: "{{ (states(humidity_entity)|float(0)) > humidity_low }}"
                                - condition: template
                                  value_template: "{{ (now() - hold_start).total_seconds() < humidity_hold_max_seconds }}"
                              sequence:
                                - delay: !input humidity_check_interval
                  - choose:
                      - conditions:
                          - condition: template
                            value_template: "{{ fan_entity != '' }}"
                        sequence:
                          - action: fan.turn_off
                            target:
                              entity_id: "{{ fan_entity }}"
                      - conditions:
                          - condition: template
                            value_template: "{{ (fan_entity == '') and (fan_switches | length > 0) }}"
                        sequence:
                          - action: switch.turn_off
                            target:
                              entity_id: !input fan_switches
                  - choose:
                      - conditions:
                          - condition: template
                            value_template: "{{ auto_tag_fan != '' }}"
                        sequence:
                          - action: input_boolean.turn_off
                            target:
                              entity_id: "{{ auto_tag_fan }}"

      # ================= VACANT -> START FAN RUN-ON (immediate) =================
      - conditions:
          - condition: trigger
            id: vacancy_began
          - condition: template
            value_template: "{{ override_ok }}"
          - condition: template
            value_template: "{{ fan_turn_off_on_vacant }}"
          - condition: template
            value_template: "{{ fan_runon_t != '' }}"
          - condition: template
            value_template: "{{ not fan_runon_after_lights }}"
          - condition: template
            value_template: "{{ tag_fan_ok_to_off }}"
          - condition: template
            value_template: "{{ fan_currently_on }}"
        sequence:
          - action: timer.start
            target:
              entity_id: "{{ fan_runon_t }}"
            data:
              duration: "{{ fan_runon_actual_seconds }}"

      # ================= FAN RUN-ON DONE -> FAN OFF =================
      - conditions:
          - condition: trigger
            id: timer_finished
          - condition: template
            value_template: "{{ fan_runon_t != '' and trigger.event.data.entity_id == fan_runon_t }}"
          - condition: template
            value_template: "{{ override_ok }}"
          - condition: template
            value_template: "{{ fan_turn_off_on_vacant and tag_fan_ok_to_off }}"
          - condition: template
            value_template: "{{ is_state(occ, 'off') }}"
          - condition: template
            value_template: "{{ force_ok }}"
        sequence:
          - variables:
              hold_start: "{{ now() }}"
          - choose:
              - conditions:
                  - condition: template
                    value_template: "{{ humidity_hold_enabled and (states(humidity_entity)|float(0)) >= humidity_high }}"
                sequence:
                  - repeat:
                      while:
                        - condition: template
                          value_template: "{{ is_state(occ,'off') and override_ok and force_ok }}"
                        - condition: template
                          value_template: "{{ (states(humidity_entity)|float(0)) > humidity_low }}"
                        - condition: template
                          value_template: "{{ (now() - hold_start).total_seconds() < humidity_hold_max_seconds }}"
                      sequence:
                        - delay: !input humidity_check_interval

          - choose:
              - conditions:
                  - condition: template
                    value_template: "{{ fan_entity != '' }}"
                sequence:
                  - action: fan.turn_off
                    target:
                      entity_id: "{{ fan_entity }}"
              - conditions:
                  - condition: template
                    value_template: "{{ (fan_entity == '') and (fan_switches | length > 0) }}"
                sequence:
                  - action: switch.turn_off
                    target:
                      entity_id: !input fan_switches
          - choose:
              - conditions:
                  - condition: template
                    value_template: "{{ auto_tag_fan != '' }}"
                sequence:
                  - action: input_boolean.turn_off
                    target:
                      entity_id: "{{ auto_tag_fan }}"

      # ================= STARTUP CLEANUP (HARDENED) =================
      - conditions:
          - condition: trigger
            id: ha_start
          - condition: template
            value_template: "{{ startup_cleanup }}"
        sequence:
          - delay: !input startup_cleanup_delay
          - condition: template
            value_template: "{{ override_ok }}"
          - condition: template
            value_template: "{{ force_ok }}"

          # CRITICAL FIX: Ensure sensor is VALID (not unavailable/unknown) and OFF
          - condition: template
            value_template: >-
              {{ has_value(occ) and is_state(occ, 'off') }}

          # Double-tap validation
          - delay: 00:00:15

          - condition: template
            value_template: >-
              {{ has_value(occ) and is_state(occ, 'off') }}

          - choose:
              - conditions:
                  - condition: template
                    value_template: >-
                      {{ auto_tag_lights != '' and is_state(auto_tag_lights,'on') and (any_light_on or (lights_off_script != '') or (lights | length > 0)) }}
                sequence:
                  - choose:
                      - conditions:
                          - condition: template
                            value_template: "{{ lights_off_script != '' }}"
                        sequence:
                          - action: script.turn_on
                            target:
                              entity_id: "{{ lights_off_script }}"
                      - conditions:
                          - condition: template
                            value_template: "{{ (lights_off_script == '') and (lights | length > 0) }}"
                        sequence:
                          - action: light.turn_off
                            target:
                              entity_id: !input lights
                            data:
                              transition: !input transition_off
                  - action: input_boolean.turn_off
                    target:
                      entity_id: "{{ auto_tag_lights }}"
          - choose:
              - conditions:
                  - condition: template
                    value_template: "{{ auto_tag_fan != '' and is_state(auto_tag_fan,'on') and fan_currently_on and (not fan_runon_active) }}"
                sequence:
                  - choose:
                      - conditions:
                          - condition: template
                            value_template: "{{ fan_entity != '' }}"
                        sequence:
                          - action: fan.turn_off
                            target:
                              entity_id: "{{ fan_entity }}"
                      - conditions:
                          - condition: template
                            value_template: "{{ (fan_entity == '') and (fan_switches | length > 0) }}"
                        sequence:
                          - action: switch.turn_off
                            target:
                              entity_id: !input fan_switches
                  - action: input_boolean.turn_off
                    target:
                      entity_id: "{{ auto_tag_fan }}"