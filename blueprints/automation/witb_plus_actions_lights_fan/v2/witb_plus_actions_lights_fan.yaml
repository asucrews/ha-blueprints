blueprint:
  homeassistant:
    min_version: 2026.2.0
  domain: automation
  source_url: https://github.com/asucrews/ha-blueprints/blob/main/blueprints/automation/witb_plus_actions_lights_fan/v2/witb_plus_actions_lights_fan.yaml
  name: WITB+ Actions - Lights + Fan v2.2.2
  description: |
    Version: 2.2.2 — see CHANGELOG.md for full version history.

    Action orchestrator for a WITB+ room. Responds to occupancy state changes
    from an occupied_effective sensor and controls lights and a fan accordingly.

    LIGHTS
      • Turns lights ON when the room becomes occupied (lux / sun gated).
      • Day and night brightness profiles with configurable transition speeds.
      • Soft-Off warning: dims to 10% for 15s before full off.
      • Turns lights OFF after a configurable vacancy delay, with retry/verify logic.
      • Manual-off hold: if you turn lights off while occupied, they stay off until
        the room goes vacant — no re-assertion from continued motion.
      • Bed suppress: if a bed sensor is configured and someone is in bed, lights
        will not auto-turn ON from occupancy re-assertion (e.g. midnight bathroom
        return, rolling over in bed).

    FAN
      • Turns fan ON on occupancy (optional delay, night-disable mode).
      • Turns fan OFF on vacancy with configurable run-on timer.
      • Day and night speed/preset profiles.
      • Humidity hold: delays fan-off if humidity is still high.

    SAFETY / RELIABILITY
      • Automation override and blocking entity inputs halt all actions.
      • Cooldown timer prevents rapid ON re-triggering.
      • Hardened startup cleanup with double-tap validation after HA restart.
      • Auto-tag helpers (input_boolean) track automation-driven state for safe
        off-only-what-we-turned-on behavior.

  input:
    core:
      name: Core
      icon: mdi:home-automation
      description: Required occupancy + optional override/cooldown/startup protections.
      collapsed: false
      input:
        occupied_effective:
          name: Effective occupancy sensor (WITB+)
          description: Use the room's effective occupancy sensor (binary_sensor.<slug>_occupied_effective).
          selector:
            entity:
              domain: binary_sensor

        automation_override:
          name: Automation override (optional)
          description: If set and ON, the blueprint performs no actions.
          # FIX #6: Standardized to '' for single-entity optionals
          default: ''
          selector:
            entity:
              domain: input_boolean

        blocking_entities:
          name: Blocking entities (optional)
          description: Select one or more input_booleans. If ANY of these are ON, vacancy actions (OFF) are blocked.
          default: []
          selector:
            entity:
              domain: input_boolean
              multiple: true

        startup_cleanup:
          name: Startup cleanup (recommended)
          description: If true, runs cleanup logic after HA restart (safe double-tap validation).
          default: true
          selector:
            boolean: null

        startup_cleanup_delay:
          name: Startup cleanup delay
          description: Delay after HA start before running cleanup.
          default: 00:00:15
          selector:
            duration: null

        on_debounce:
          name: Occupied debounce
          description: Require occupied_effective to be ON for this long before running ON actions.
          default: 00:00:00
          selector:
            duration: null

        cooldown_timer:
          name: Cooldown timer (optional)
          description: Optional timer to prevent rapid ON triggering.
          default: ''
          selector:
            entity:
              domain: timer

        cooldown_duration:
          name: Cooldown duration
          description: Duration used when starting cooldown_timer.
          default: 00:00:30
          selector:
            duration: null

    lights:
      name: Lights
      icon: mdi:lightbulb
      description: Light targets and behavior.
      collapsed: false
      input:
        lights:
          name: Lights to control
          description: Lights this automation may turn on/off.
          default: []
          selector:
            entity:
              domain: light
              multiple: true

        auto_tag_lights:
          name: Auto-tag boolean for lights (recommended)
          description: Set ON when automation turns lights ON; required for safe OFF.
          default: ''
          selector:
            entity:
              domain: input_boolean

        bed_occupied:
          name: 'Lights: bed sensor (optional)'
          description: >
            Binary sensor that is ON when someone is in bed (e.g. Bed Occupied Either Fast).
            Used by suppress_lights_on_when_in_bed. Leave empty to disable bed awareness.
          default: ''
          selector:
            entity:
              domain: binary_sensor

        suppress_lights_on_when_in_bed:
          name: 'Lights: suppress auto-ON when in bed'
          description: >
            When ON: if the bed sensor is ON and lights are currently OFF,
            occupied_on will NOT turn lights on. Prevents motion re-assertion
            (e.g. midnight bathroom return) from waking lights.
            Requires bed_occupied to be set. Has no effect if bed_occupied is empty.
          default: true
          selector:
            boolean: null

        lights_on_script:
          name: Lights ON script (optional)
          default: ''
          selector:
            entity:
              domain: script

        lights_off_script:
          name: Lights OFF script (optional)
          default: ''
          selector:
            entity:
              domain: script

        transition_on:
          name: 'Lights: ON transition (Day)'
          default: 1
          selector:
            number:
              min: 0
              max: 30
              mode: slider

        transition_on_night:
          name: 'Lights: ON transition (Night)'
          default: 3
          selector:
            number:
              min: 0
              max: 30
              mode: slider

        transition_off:
          name: 'Lights: OFF transition'
          default: 2
          selector:
            number:
              min: 0
              max: 60
              mode: slider

        lights_soft_off_enabled:
          name: 'Lights: Soft-Off Warning'
          description: If true, lights dim to 10% for 15s before turning off completely.
          default: false
          selector:
            boolean: null

        skip_on_if_any_light_on:
          name: 'Lights: skip turning ON if already ON'
          default: true
          selector:
            boolean: null

        lights_off_delay:
          name: 'Lights: off-delay after vacancy'
          default: 00:02:00
          selector:
            duration: null

    lights_off_verification:
      name: Lights off verification
      icon: mdi:timer-refresh
      description: Retry / verify logic.
      collapsed: true
      input:
        lights_off_verify_enabled:
          name: 'Lights: verify/retry OFF'
          default: true
          selector:
            boolean: null

        lights_off_verify_delay:
          name: 'Lights: initial verify delay'
          default: 00:00:05
          selector:
            duration: null

        lights_off_verify_retries:
          name: 'Lights: max retry attempts'
          default: 3
          selector:
            number:
              min: 0
              max: 10
              mode: slider

        lights_off_verify_retry_interval:
          name: 'Lights: retry interval'
          default: 00:00:05
          selector:
            duration: null

        lights_off_keep_tag_on_failure:
          name: 'Lights: keep auto-tag ON on failure'
          default: true
          selector:
            boolean: null

    light_gating:
      name: Light gating
      icon: mdi:weather-night
      description: Lux/Sun gating logic.
      collapsed: true
      input:
        turn_on_only_if_dark:
          name: 'Lights: only turn ON when dark (sun)'
          default: true
          selector:
            boolean: null

        use_illuminance_gate:
          name: 'Lights: use illuminance sensor gate'
          default: true
          selector:
            boolean: null

        illuminance_entity:
          name: 'Lights: illuminance sensor'
          default: ''
          selector:
            entity:
              domain: sensor

        illuminance_threshold:
          name: 'Lights: illuminance threshold (static lux)'
          description: >
            Lights turn ON when lux is below this value (with 10% hysteresis buffer
            to prevent dusk flickering). E.g. threshold=30 → turns on below 33 lux.
          default: 30
          selector:
            number:
              min: 0
              max: 5000
              mode: box

        illuminance_threshold_helper:
          name: 'Lights: illuminance threshold helper'
          default: ''
          selector:
            entity:
              domain: input_number

    night_profile:
      name: Night profile
      icon: mdi:clock-outline
      collapsed: true
      input:
        use_night_profile:
          name: 'Lights: use night brightness profile'
          default: true
          selector:
            boolean: null

        night_start:
          name: Night start
          default: 00:00:00
          selector:
            time: null

        night_end:
          name: Night end
          default: 06:00:00
          selector:
            time: null

        night_start_helper:
          name: Night start helper
          # FIX #6: Standardized to '' for single-entity optionals
          default: ''
          selector:
            entity:
              domain: input_datetime

        night_end_helper:
          name: Night end helper
          default: ''
          selector:
            entity:
              domain: input_datetime

        brightness_day_helper:
          name: 'Lights: day brightness helper'
          default: ''
          selector:
            entity:
              domain: input_number

        brightness_night_helper:
          name: 'Lights: night brightness helper'
          default: ''
          selector:
            entity:
              domain: input_number

        brightness_day_pct:
          name: 'Lights: day brightness %'
          default: 100
          selector:
            number:
              min: 1
              max: 100
              mode: slider

        brightness_night_pct:
          name: 'Lights: night brightness %'
          default: 20
          selector:
            number:
              min: 1
              max: 100
              mode: slider

    fan_basic:
      name: Fan
      icon: mdi:fan
      description: Fan targets and behavior.
      collapsed: false
      input:
        fan_entity:
          name: Fan entity (optional)
          default: ''
          selector:
            entity:
              domain: fan

        fan_switches:
          name: Fan switches (optional)
          default: []
          selector:
            entity:
              # FIX #5: Corrected indentation from 1 space to 2 spaces (valid YAML)
              domain:
                - switch
                - light
              multiple: true

        auto_tag_fan:
          name: Auto-tag boolean for fan
          default: ''
          selector:
            entity:
              domain: input_boolean

        fan_turn_on_on_occupy:
          name: 'Fan: turn ON on occupancy'
          default: true
          selector:
            boolean: null

        fan_turn_off_on_vacant:
          name: 'Fan: turn OFF when vacant'
          default: true
          selector:
            boolean: null

        fan_skip_on_if_already_on:
          name: 'Fan: skip ON if already ON'
          default: true
          selector:
            boolean: null

        fan_disable_during_night:
          name: 'Fan: do NOT turn ON during night window'
          default: false
          selector:
            boolean: null

    fan_timing:
      name: Fan timing
      icon: mdi:timer-outline
      collapsed: true
      input:
        fan_on_delay:
          name: 'Fan: ON delay after occupancy (static)'
          default: 00:00:00
          selector:
            duration: null

        fan_on_delay_seconds_helper:
          name: 'Fan: ON delay helper'
          default: ''
          selector:
            entity:
              domain: input_number

        fan_runon_timer:
          name: 'Fan: run-on timer helper'
          default: ''
          selector:
            entity:
              domain: timer

        fan_runon_duration:
          name: 'Fan: run-on duration (static fallback)'
          description: Used if helper below is not set.
          default: 00:10:00
          selector:
            duration: null

        fan_runon_minutes_helper:
          name: 'Fan: run-on duration helper (input_number minutes)'
          description: Optional. Overrides static duration. Matches dashboard slider.
          default: ''
          selector:
            entity:
              domain: input_number

        fan_runon_starts_after_lights_off:
          name: 'Fan: start run-on AFTER lights turn off'
          default: true
          selector:
            boolean: null

    fan_profile:
      name: Fan speed profile
      icon: mdi:fan-speed-1
      collapsed: true
      input:
        fan_use_night_profile:
          name: 'Fan: use night profile'
          default: false
          selector:
            boolean: null

        fan_percentage_day:
          name: 'Fan: day percentage'
          default: 0
          selector:
            number:
              min: 0
              max: 100
              mode: slider

        fan_percentage_night:
          name: 'Fan: night percentage'
          default: 0
          selector:
            number:
              min: 0
              max: 100
              mode: slider

        fan_percentage_day_helper:
          name: 'Fan: day percentage helper'
          default: ''
          selector:
            entity:
              domain: input_number

        fan_percentage_night_helper:
          name: 'Fan: night percentage helper'
          default: ''
          selector:
            entity:
              domain: input_number

        fan_preset_day:
          name: 'Fan: day preset_mode'
          default: ''
          selector:
            text: null

        fan_preset_night:
          name: 'Fan: night preset_mode'
          default: ''
          selector:
            text: null

    humidity_hold:
      name: Humidity hold
      icon: mdi:water-percent
      collapsed: true
      input:
        humidity_entity:
          name: 'Fan: humidity sensor'
          default: ''
          selector:
            entity:
              domain: sensor

        humidity_high:
          name: 'Fan: humidity high threshold (%)'
          default: 65
          selector:
            number:
              min: 0
              max: 100
              mode: slider

        humidity_low:
          name: 'Fan: humidity low threshold (%)'
          default: 55
          selector:
            number:
              min: 0
              max: 100
              mode: slider

        humidity_high_helper:
          name: 'Fan: humidity high helper'
          default: ''
          selector:
            entity:
              domain: input_number

        humidity_low_helper:
          name: 'Fan: humidity low helper'
          default: ''
          selector:
            entity:
              domain: input_number

        humidity_check_interval:
          name: 'Fan: humidity re-check interval'
          default: 00:02:00
          selector:
            duration: null

        humidity_hold_max:
          name: 'Fan: max humidity hold time'
          default: 01:00:00
          selector:
            duration: null

mode: restart
max_exceeded: silent

triggers:
  - trigger: state
    entity_id: !input occupied_effective
    to: "on"
    for: !input on_debounce
    id: occupied_on

  - trigger: state
    entity_id: !input occupied_effective
    to: "off"
    for: !input lights_off_delay
    id: lights_off

  - trigger: state
    entity_id: !input occupied_effective
    to: "off"
    id: vacancy_began

  # FIX #1: Scoped to fan_runon_timer only via event_data filter.
  # Previously this had no filter and fired on EVERY timer.finished event in
  # the entire HA instance — exit_eval timers, failsafe timers, cooldown timers
  # from every other room — causing the automation to run needlessly for all of
  # them. The action guard (trigger.event.data.entity_id == fan_runon_t) caught
  # it eventually, but not before evaluating all variables for every run.
  - trigger: event
    event_type: timer.finished
    event_data:
      entity_id: !input fan_runon_timer
    id: timer_finished

  - trigger: homeassistant
    event: start
    id: ha_start

variables:
  occ: !input occupied_effective

  lights: !input lights
  lights_on_script: !input lights_on_script
  lights_off_script: !input lights_off_script
  lights_soft_off_enabled: !input lights_soft_off_enabled

  lights_control_enabled: >-
    {{ (lights | length > 0) or (lights_on_script != '') or (lights_off_script != '') }}

  fan_entity: !input fan_entity
  fan_switches: !input fan_switches

  override_b: !input automation_override
  blocking_entities: !input blocking_entities

  auto_tag_lights: !input auto_tag_lights
  auto_tag_fan: !input auto_tag_fan

  cooldown_t: !input cooldown_timer

  # Light gating
  turn_on_only_if_dark: !input turn_on_only_if_dark
  lux_entity: !input illuminance_entity
  use_lux_gate: !input use_illuminance_gate
  lux_threshold_static: !input illuminance_threshold
  lux_threshold_helper: !input illuminance_threshold_helper

  use_night_profile: !input use_night_profile
  night_start: !input night_start
  night_start_helper: !input night_start_helper
  night_end: !input night_end
  night_end_helper: !input night_end_helper

  brightness_day_static: !input brightness_day_pct
  brightness_day_helper: !input brightness_day_helper
  brightness_night_static: !input brightness_night_pct
  brightness_night_helper: !input brightness_night_helper

  transition_on: !input transition_on
  transition_on_night: !input transition_on_night

  # Fan timing and behavior
  fan_turn_on_on_occupy: !input fan_turn_on_on_occupy
  fan_on_delay_static: !input fan_on_delay
  fan_on_delay_seconds_helper: !input fan_on_delay_seconds_helper
  fan_turn_off_on_vacant: !input fan_turn_off_on_vacant
  fan_disable_during_night: !input fan_disable_during_night
  fan_runon_t: !input fan_runon_timer
  fan_runon_duration: !input fan_runon_duration
  fan_runon_minutes_helper: !input fan_runon_minutes_helper
  fan_runon_after_lights: !input fan_runon_starts_after_lights_off

  # Humidity hold
  humidity_entity: !input humidity_entity
  humidity_high_static: !input humidity_high
  humidity_low_static: !input humidity_low
  humidity_high_helper: !input humidity_high_helper
  humidity_low_helper: !input humidity_low_helper
  humidity_check_interval: !input humidity_check_interval
  humidity_hold_max: !input humidity_hold_max

  fan_use_night_profile: !input fan_use_night_profile
  fan_pct_day_static: !input fan_percentage_day
  fan_pct_day_helper: !input fan_percentage_day_helper
  fan_pct_night_static: !input fan_percentage_night
  fan_pct_night_helper: !input fan_percentage_night_helper
  fan_preset_day: !input fan_preset_day
  fan_preset_night: !input fan_preset_night
  fan_skip_on_if_already_on: !input fan_skip_on_if_already_on

  startup_cleanup: !input startup_cleanup
  startup_cleanup_delay: !input startup_cleanup_delay

  skip_on_if_any_light_on: !input skip_on_if_any_light_on

  # Vacancy OFF verification (lights)
  lights_off_verify_enabled: !input lights_off_verify_enabled
  lights_off_verify_delay: !input lights_off_verify_delay
  lights_off_verify_retries: !input lights_off_verify_retries
  lights_off_verify_retry_interval: !input lights_off_verify_retry_interval
  lights_off_keep_tag_on_failure: !input lights_off_keep_tag_on_failure

  # NOTE: override_ok and force_ok are kept as top-level variables for use in
  # simple single-shot conditions (occupied_on, lights_off, vacancy_began).
  # For any blocking while-loops (humidity hold, lights retry), these are
  # intentionally NOT used — see FIX #2 inline comments below.
  override_ok: >-
    {{ override_b == '' or is_state(override_b, 'off') }}

  force_ok: >-
    {{ expand(blocking_entities) | selectattr('state','eq','on') | list | count == 0 }}

  cooldown_active: >-
    {{ cooldown_t != '' and is_state(cooldown_t, 'active') }}

  is_dark: >-
    {{ is_state('sun.sun', 'below_horizon') }}

  is_night: >-
    {% set start_t = (states(night_start_helper) if night_start_helper != '' else night_start) %}
    {% set end_t = (states(night_end_helper) if night_end_helper != '' else night_end) %}
    {% set start = today_at(start_t) %}
    {% set end = today_at(end_t) %}
    {% if start <= end %}
      {{ start <= now() < end }}
    {% else %}
      {{ now() >= start or now() < end }}
    {% endif %}

  lux_value: >-
    {% if lux_entity != '' %}
      {{ states(lux_entity) | float(999999) }}
    {% else %}
      999999
    {% endif %}

  lux_threshold: >-
    {% if lux_threshold_helper != '' %}
      {{ states(lux_threshold_helper) | float(lux_threshold_static) }}
    {% else %}
      {{ lux_threshold_static | float }}
    {% endif %}

  # FIX #3: Apply the 10% hysteresis buffer that was advertised in the v2.1.1
  # changelog but never implemented. The original check was strict
  # `lux_value < lux_threshold` with no buffer, causing dusk flicker when lux
  # hovered near the threshold. Now: lights turn ON if lux < threshold * 1.1,
  # giving a 10% tolerance band above the configured threshold.
  # FIX #7: Removed the stale comment block that contradicted this fix
  # ("Actually, simple gate... If you want hysteresis...").
  lights_ok_to_turn_on: >-
    {% if lux_entity != '' and use_lux_gate %}
      {{ lux_value < (lux_threshold * 1.1) }}
    {% else %}
      {{ (not turn_on_only_if_dark) or is_dark }}
    {% endif %}

  light_brightness_pct: >-
    {% set day = (states(brightness_day_helper) | int(brightness_day_static)) if brightness_day_helper != '' else (brightness_day_static | int) %}
    {% set night = (states(brightness_night_helper) | int(brightness_night_static)) if brightness_night_helper != '' else (brightness_night_static | int) %}
    {% if use_night_profile and is_night %}
      {{ night }}
    {% else %}
      {{ day }}
    {% endif %}

  transition_on_actual: >-
    {% if use_night_profile and is_night %}
      {{ transition_on_night }}
    {% else %}
      {{ transition_on }}
    {% endif %}

  fan_pct: >-
    {% set day = (states(fan_pct_day_helper) | int(fan_pct_day_static)) if fan_pct_day_helper != '' else (fan_pct_day_static | int) %}
    {% set night = (states(fan_pct_night_helper) | int(fan_pct_night_static)) if fan_pct_night_helper != '' else (fan_pct_night_static | int) %}
    {% if fan_use_night_profile and is_night %}
      {{ night }}
    {% else %}
      {{ day }}
    {% endif %}

  fan_preset: >-
    {% if fan_use_night_profile and is_night %}
      {{ fan_preset_night }}
    {% else %}
      {{ fan_preset_day }}
    {% endif %}

  fan_on_delay_seconds: >-
    {% if fan_on_delay_seconds_helper != '' %}
      {{ states(fan_on_delay_seconds_helper) | float(0) }}
    {% else %}
      {{ as_timedelta(fan_on_delay_static).total_seconds() }}
    {% endif %}

  fan_runon_actual_seconds: >-
    {% if fan_runon_minutes_helper != '' %}
      {{ (states(fan_runon_minutes_helper) | float(0)) * 60 }}
    {% else %}
      {{ as_timedelta(fan_runon_duration).total_seconds() }}
    {% endif %}

  any_light_on: >-
    {{ expand(lights) | selectattr('state','eq','on') | list | count > 0 }}

  # ADD #3 (v2.2.1): Safe in-bed check. Handles none and '' input gracefully.
  bed_occupied_entity: !input bed_occupied
  suppress_lights_on_when_in_bed: !input suppress_lights_on_when_in_bed

  in_bed: >-
    {{ bed_occupied_entity is not none
       and bed_occupied_entity != ''
       and is_state(bed_occupied_entity, 'on') }}

  # ADD #4 (v2.2.1): Manual-off hold.
  # True when: automation tagged the lights as turned-on (auto_tag_lights is ON)
  # but the lights are now all off — meaning the user manually turned them off.
  # Holds until vacancy clears auto_tag_lights.
  # Falls back to false when auto_tag_lights is not configured (fully backward compatible).
  manual_off_hold: >-
    {% if auto_tag_lights != '' and states(auto_tag_lights) not in ['unknown', 'unavailable'] %}
      {{ is_state(auto_tag_lights, 'on') and (not any_light_on) }}
    {% else %}
      false
    {% endif %}

  fan_is_on: >-
    {{ fan_entity != '' and is_state(fan_entity, 'on') }}

  any_fan_switch_on: >-
    {{ (fan_switches | length > 0) and (expand(fan_switches) | selectattr('state','eq','on') | list | count > 0) }}

  fan_currently_on: >-
    {{ fan_is_on or any_fan_switch_on }}

  fan_runon_active: >-
    {{ fan_runon_t != '' and is_state(fan_runon_t, 'active') }}

  tag_lights_ok_to_off: >-
    {{ auto_tag_lights == '' or is_state(auto_tag_lights, 'on') }}

  tag_fan_ok_to_off: >-
    {{ auto_tag_fan == '' or is_state(auto_tag_fan, 'on') }}

  humidity_high: >-
    {% if humidity_high_helper != '' %}
      {{ states(humidity_high_helper) | float(humidity_high_static) }}
    {% else %}
      {{ humidity_high_static | float }}
    {% endif %}

  humidity_low: >-
    {% if humidity_low_helper != '' %}
      {{ states(humidity_low_helper) | float(humidity_low_static) }}
    {% else %}
      {{ humidity_low_static | float }}
    {% endif %}

  humidity_hold_enabled: >-
    {{ humidity_entity != '' and auto_tag_fan != '' and is_state(auto_tag_fan, 'on') }}

  humidity_hold_max_seconds: >-
    {{ as_timedelta(humidity_hold_max).total_seconds() }}

actions:
  - choose:
      # ================= OCCUPIED -> ON =================
      - conditions:
          - condition: trigger
            id: occupied_on
          - condition: template
            value_template: "{{ override_ok }}"
          - condition: template
            value_template: "{{ not cooldown_active }}"
        sequence:
          # Cancel fan run-on timer if present (room is occupied again)
          - choose:
              - conditions:
                  - condition: template
                    value_template: "{{ fan_runon_t != '' }}"
                sequence:
                  - action: timer.cancel
                    target:
                      entity_id: "{{ fan_runon_t }}"

          # ---- Lights ON ----
          - choose:
              - conditions:
                  - condition: template
                    value_template: "{{ lights_control_enabled }}"
                  - condition: template
                    value_template: "{{ lights_ok_to_turn_on }}"
                  - condition: template
                    value_template: "{{ (not skip_on_if_any_light_on) or (not any_light_on) }}"
                  # ADD #5a (v2.2.1): manual-off hold guard.
                  # If the automation previously turned lights on but they are now off,
                  # the user manually turned them off — don't bring them back.
                  - condition: template
                    value_template: "{{ not manual_off_hold }}"
                  # ADD #5b (v2.2.1): in-bed suppress guard.
                  # If someone is in bed and lights are currently off, don't turn them
                  # on due to occupancy re-assertion (e.g. midnight bathroom return).
                  - condition: template
                    value_template: "{{ not (suppress_lights_on_when_in_bed and in_bed and (not any_light_on)) }}"
                sequence:
                  - choose:
                      - conditions:
                          - condition: template
                            value_template: "{{ lights_on_script != '' }}"
                        sequence:
                          - action: script.turn_on
                            target:
                              entity_id: "{{ lights_on_script }}"
                          - choose:
                              - conditions:
                                  - condition: template
                                    value_template: "{{ auto_tag_lights != '' }}"
                                sequence:
                                  - action: input_boolean.turn_on
                                    target:
                                      entity_id: "{{ auto_tag_lights }}"
                      - conditions:
                          - condition: template
                            value_template: "{{ (lights_on_script == '') and (lights | length > 0) }}"
                        sequence:
                          - action: light.turn_on
                            target:
                              entity_id: !input lights
                            data:
                              brightness_pct: "{{ light_brightness_pct }}"
                              transition: "{{ transition_on_actual }}"
                          - choose:
                              - conditions:
                                  - condition: template
                                    value_template: "{{ auto_tag_lights != '' }}"
                                sequence:
                                  - action: input_boolean.turn_on
                                    target:
                                      entity_id: "{{ auto_tag_lights }}"

          # ---- Fan ON (with optional delay) ----
          - choose:
              - conditions:
                  - condition: template
                    value_template: "{{ fan_turn_on_on_occupy }}"
                  - condition: template
                    value_template: "{{ (not fan_disable_during_night) or (not is_night) }}"
                sequence:
                  - choose:
                      - conditions:
                          - condition: template
                            value_template: "{{ fan_on_delay_seconds | float(0) > 0 }}"
                        sequence:
                          - delay:
                              seconds: "{{ fan_on_delay_seconds | int(0) }}"
                          - condition: template
                            value_template: "{{ is_state(occ, 'on') and override_ok }}"
                  - choose:
                      - conditions:
                          - condition: template
                            value_template: "{{ fan_entity != '' }}"
                          - condition: template
                            value_template: "{{ (not fan_skip_on_if_already_on) or (not fan_is_on) }}"
                        sequence:
                          - action: fan.turn_on
                            target:
                              entity_id: "{{ fan_entity }}"
                          - choose:
                              - conditions:
                                  - condition: template
                                    value_template: "{{ fan_pct | int > 0 }}"
                                sequence:
                                  - action: fan.set_percentage
                                    target:
                                      entity_id: "{{ fan_entity }}"
                                    data:
                                      percentage: "{{ fan_pct | int }}"
                          - choose:
                              - conditions:
                                  - condition: template
                                    value_template: "{{ fan_preset is string and fan_preset | length > 0 }}"
                                sequence:
                                  - action: fan.set_preset_mode
                                    target:
                                      entity_id: "{{ fan_entity }}"
                                    data:
                                      preset_mode: "{{ fan_preset }}"
                          - choose:
                              - conditions:
                                  - condition: template
                                    value_template: "{{ auto_tag_fan != '' }}"
                                sequence:
                                  - action: input_boolean.turn_on
                                    target:
                                      entity_id: "{{ auto_tag_fan }}"

                      - conditions:
                          - condition: template
                            value_template: "{{ (fan_entity == '') and (fan_switches | length > 0) }}"
                        sequence:
                          - action: switch.turn_on
                            target:
                              entity_id: !input fan_switches
                          - choose:
                              - conditions:
                                  - condition: template
                                    value_template: "{{ auto_tag_fan != '' }}"
                                sequence:
                                  - action: input_boolean.turn_on
                                    target:
                                      entity_id: "{{ auto_tag_fan }}"

          # ---- Cooldown timer ----
          - choose:
              - conditions:
                  - condition: template
                    value_template: "{{ cooldown_t != '' }}"
                sequence:
                  - action: timer.start
                    target:
                      entity_id: "{{ cooldown_t }}"
                    data:
                      duration: !input cooldown_duration

      # ================= VACANT -> LIGHTS OFF =================
      - conditions:
          - condition: trigger
            id: lights_off
          - condition: template
            value_template: "{{ override_ok }}"
          - condition: template
            value_template: "{{ force_ok }}"
        sequence:
          # Lights OFF Sequence
          - choose:
              - conditions:
                  - condition: template
                    value_template: "{{ lights_control_enabled and tag_lights_ok_to_off }}"
                sequence:
                  - variables:
                      _lights_off_retries: "{{ lights_off_verify_retries | int(0) }}"
                      # FIX: Capture whether any lights were ON right now, before we attempt
                      # to turn them off. Used below to guard auto-tag clearing — if lights
                      # were already off at vacancy time (manual-off hold), we must NOT clear
                      # auto_tag_lights, so the hold survives the vacancy/re-occupy cycle.
                      _lights_on_at_vacancy: >-
                        {% if lights | length > 0 %}
                          {{ expand(lights) | selectattr('state','eq','on') | list | count > 0 }}
                        {% else %}
                          false
                        {% endif %}

                  # Soft-Off Warning (Dim to 10% for 15s before full off)
                  - choose:
                      - conditions:
                          - condition: template
                            value_template: "{{ lights_soft_off_enabled and (lights | length > 0) }}"
                        sequence:
                          - action: light.turn_on
                            target:
                              entity_id: !input lights
                            data:
                              brightness_pct: 10
                              transition: 2
                          - delay: 00:00:15
                          # If room became occupied again during soft-off delay, mode:restart
                          # will have cancelled this run already — no explicit check needed.

                  # First OFF attempt
                  - choose:
                      - conditions:
                          - condition: template
                            value_template: "{{ lights_off_script != '' }}"
                        sequence:
                          - action: script.turn_on
                            target:
                              entity_id: "{{ lights_off_script }}"
                      - conditions:
                          - condition: template
                            value_template: "{{ (lights_off_script == '') and (lights | length > 0) }}"
                        sequence:
                          - action: light.turn_off
                            target:
                              entity_id: !input lights
                            data:
                              transition: !input transition_off

                  # Verify + retry OFF (optional)
                  - choose:
                      - conditions:
                          - condition: template
                            value_template: "{{ lights_off_verify_enabled and ((_lights_off_retries | int(0)) > 0) }}"
                        sequence:
                          - delay: !input lights_off_verify_delay
                          - repeat:
                              count: "{{ _lights_off_retries | int(0) }}"
                              sequence:
                                # FIX #2: Inline live check instead of frozen override_ok/force_ok
                                # variables. The retry loop runs over multiple delay cycles — if
                                # override or a blocking entity is turned on mid-retry, this now
                                # catches it immediately.
                                - condition: template
                                  value_template: >-
                                    {{ is_state(occ, 'off')
                                       and (override_b == '' or is_state(override_b, 'off'))
                                       and (expand(blocking_entities) | selectattr('state','eq','on') | list | count == 0) }}
                                # Check for lights that are ON or UNAVAILABLE/UNKNOWN (safety)
                                - choose:
                                    - conditions:
                                        - condition: template
                                          value_template: >-
                                            {{ (lights | length > 0) and (expand(lights) | selectattr('state', 'in', ['on', 'unavailable', 'unknown']) | list | count > 0) }}
                                      sequence:
                                        - choose:
                                            - conditions:
                                                - condition: template
                                                  value_template: "{{ lights_off_script != '' }}"
                                              sequence:
                                                - action: script.turn_on
                                                  target:
                                                    entity_id: "{{ lights_off_script }}"
                                            - conditions:
                                                - condition: template
                                                  value_template: "{{ (lights_off_script == '') and (lights | length > 0) }}"
                                              sequence:
                                                - action: light.turn_off
                                                  target:
                                                    entity_id: !input lights
                                                  data:
                                                    transition: !input transition_off
                                    - conditions:
                                        - condition: template
                                          value_template: "{{ (lights | length == 0) and (lights_off_script != '') }}"
                                      sequence:
                                        - action: script.turn_on
                                          target:
                                            entity_id: "{{ lights_off_script }}"
                                - delay: !input lights_off_verify_retry_interval

                  # Clear auto-tag
                  # FIX: Only clear auto_tag_lights if lights were actually ON when vacancy
                  # triggered (_lights_on_at_vacancy). If they were already off — because the
                  # user manually turned them off while occupied (manual_off_hold case) — we
                  # preserve the tag so the hold survives this vacancy and blocks re-assertion
                  # from continued/new occupancy (e.g. second person still in the room/bed).
                  - choose:
                      - conditions:
                          - condition: template
                            value_template: "{{ auto_tag_lights != '' and _lights_on_at_vacancy }}"
                        sequence:
                          - variables:
                              _lights_still_on: >-
                                {% if lights | length > 0 %}
                                  {{ expand(lights) | selectattr('state','eq','on') | list | count > 0 }}
                                {% else %}
                                  {{ lights_off_keep_tag_on_failure }}
                                {% endif %}
                          - choose:
                              - conditions:
                                  - condition: template
                                    value_template: "{{ (not _lights_still_on) or (not lights_off_keep_tag_on_failure) }}"
                                sequence:
                                  - action: input_boolean.turn_off
                                    target:
                                      entity_id: "{{ auto_tag_lights }}"

          # Start fan run-on AFTER lights off
          - choose:
              - conditions:
                  - condition: template
                    value_template: "{{ fan_turn_off_on_vacant and fan_runon_t != '' and fan_runon_after_lights }}"
                  - condition: template
                    value_template: "{{ tag_fan_ok_to_off and fan_currently_on }}"
                sequence:
                  - action: timer.start
                    target:
                      entity_id: "{{ fan_runon_t }}"
                    data:
                      duration: "{{ fan_runon_actual_seconds }}"

          # Fallback: no fan run-on timer — turn fan off directly (with humidity hold)
          - choose:
              - conditions:
                  - condition: template
                    value_template: "{{ fan_turn_off_on_vacant and tag_fan_ok_to_off and fan_runon_t == '' }}"
                sequence:
                  - variables:
                      hold_start: "{{ now() }}"
                  - choose:
                      - conditions:
                          - condition: template
                            value_template: "{{ humidity_hold_enabled and (states(humidity_entity)|float(0)) >= humidity_high }}"
                        sequence:
                          - repeat:
                              while:
                                # FIX #2: Inline live override/force/blocking checks.
                                # This loop can block for up to humidity_hold_max (default 1h).
                                # Using the frozen top-level override_ok/force_ok here meant
                                # turning override ON mid-loop had zero effect. Now re-evaluated
                                # every iteration against current entity state.
                                - condition: template
                                  value_template: >-
                                    {{ is_state(occ, 'off')
                                       and (override_b == '' or is_state(override_b, 'off'))
                                       and (expand(blocking_entities) | selectattr('state','eq','on') | list | count == 0) }}
                                - condition: template
                                  value_template: "{{ (states(humidity_entity)|float(0)) > humidity_low }}"
                                - condition: template
                                  value_template: "{{ (now() - hold_start).total_seconds() < humidity_hold_max_seconds }}"
                              sequence:
                                - delay: !input humidity_check_interval
                  - choose:
                      - conditions:
                          - condition: template
                            value_template: "{{ fan_entity != '' }}"
                        sequence:
                          - action: fan.turn_off
                            target:
                              entity_id: "{{ fan_entity }}"
                      - conditions:
                          - condition: template
                            value_template: "{{ (fan_entity == '') and (fan_switches | length > 0) }}"
                        sequence:
                          - action: switch.turn_off
                            target:
                              entity_id: !input fan_switches
                  - choose:
                      - conditions:
                          - condition: template
                            value_template: "{{ auto_tag_fan != '' }}"
                        sequence:
                          - action: input_boolean.turn_off
                            target:
                              entity_id: "{{ auto_tag_fan }}"

      # ================= VACANT -> START FAN RUN-ON (immediate) =================
      - conditions:
          - condition: trigger
            id: vacancy_began
          - condition: template
            value_template: "{{ override_ok }}"
          - condition: template
            value_template: "{{ fan_turn_off_on_vacant }}"
          - condition: template
            value_template: "{{ fan_runon_t != '' }}"
          - condition: template
            value_template: "{{ not fan_runon_after_lights }}"
          - condition: template
            value_template: "{{ tag_fan_ok_to_off }}"
          - condition: template
            value_template: "{{ fan_currently_on }}"
        sequence:
          - action: timer.start
            target:
              entity_id: "{{ fan_runon_t }}"
            data:
              duration: "{{ fan_runon_actual_seconds }}"

      # ================= FAN RUN-ON DONE -> FAN OFF =================
      - conditions:
          - condition: trigger
            id: timer_finished
          # FIX #1: The event_data filter on the trigger already ensures this only
          # fires for fan_runon_timer. This condition is kept as a safety belt.
          - condition: template
            value_template: "{{ fan_runon_t != '' and trigger.event.data.entity_id == fan_runon_t }}"
          - condition: template
            value_template: "{{ override_ok }}"
          - condition: template
            value_template: "{{ fan_turn_off_on_vacant and tag_fan_ok_to_off }}"
          - condition: template
            value_template: "{{ is_state(occ, 'off') }}"
          - condition: template
            value_template: "{{ force_ok }}"
        sequence:
          - variables:
              hold_start: "{{ now() }}"
          - choose:
              - conditions:
                  - condition: template
                    value_template: "{{ humidity_hold_enabled and (states(humidity_entity)|float(0)) >= humidity_high }}"
                sequence:
                  - repeat:
                      while:
                        # FIX #2: Same inline live check as the humidity hold above.
                        # Fan run-on done can also block here for up to humidity_hold_max.
                        - condition: template
                          value_template: >-
                            {{ is_state(occ, 'off')
                               and (override_b == '' or is_state(override_b, 'off'))
                               and (expand(blocking_entities) | selectattr('state','eq','on') | list | count == 0) }}
                        - condition: template
                          value_template: "{{ (states(humidity_entity)|float(0)) > humidity_low }}"
                        - condition: template
                          value_template: "{{ (now() - hold_start).total_seconds() < humidity_hold_max_seconds }}"
                      sequence:
                        - delay: !input humidity_check_interval

          - choose:
              - conditions:
                  - condition: template
                    value_template: "{{ fan_entity != '' }}"
                sequence:
                  - action: fan.turn_off
                    target:
                      entity_id: "{{ fan_entity }}"
              - conditions:
                  - condition: template
                    value_template: "{{ (fan_entity == '') and (fan_switches | length > 0) }}"
                sequence:
                  - action: switch.turn_off
                    target:
                      entity_id: !input fan_switches
          - choose:
              - conditions:
                  - condition: template
                    value_template: "{{ auto_tag_fan != '' }}"
                sequence:
                  - action: input_boolean.turn_off
                    target:
                      entity_id: "{{ auto_tag_fan }}"

      # ================= STARTUP CLEANUP (HARDENED) =================
      - conditions:
          - condition: trigger
            id: ha_start
          - condition: template
            value_template: "{{ startup_cleanup }}"
        sequence:
          - delay: !input startup_cleanup_delay

          # FIX #8: Use inline live override/force checks rather than the frozen
          # top-level variables. After startup_cleanup_delay + 15s double-tap,
          # the cached values may be stale.
          - condition: template
            value_template: >-
              {{ override_b == '' or is_state(override_b, 'off') }}
          - condition: template
            value_template: >-
              {{ expand(blocking_entities) | selectattr('state','eq','on') | list | count == 0 }}

          # Ensure sensor is VALID (not unavailable/unknown) and OFF
          - condition: template
            value_template: >-
              {{ has_value(occ) and is_state(occ, 'off') }}

          # Double-tap validation: wait 15s then re-check
          - delay: 00:00:15

          - condition: template
            value_template: >-
              {{ has_value(occ) and is_state(occ, 'off') }}

          - choose:
              - conditions:
                  - condition: template
                    value_template: >-
                      {{ auto_tag_lights != '' and is_state(auto_tag_lights,'on')
                         and (lights_off_script != '' or lights | length > 0) }}
                sequence:
                  # FIX #4: Re-evaluate any_light_on inline — top-level variable was
                  # frozen at ha_start time and is stale after the cleanup delay.
                  - variables:
                      _any_light_on_now: >-
                        {{ expand(lights) | selectattr('state','eq','on') | list | count > 0 }}
                  - choose:
                      - conditions:
                          - condition: template
                            value_template: "{{ lights_off_script != '' }}"
                        sequence:
                          - action: script.turn_on
                            target:
                              entity_id: "{{ lights_off_script }}"
                      - conditions:
                          - condition: template
                            value_template: "{{ (lights_off_script == '') and (lights | length > 0) }}"
                        sequence:
                          - action: light.turn_off
                            target:
                              entity_id: !input lights
                            data:
                              transition: !input transition_off
                  - action: input_boolean.turn_off
                    target:
                      entity_id: "{{ auto_tag_lights }}"

          - choose:
              - conditions:
                  - condition: template
                    # FIX #4: Re-evaluate fan_runon_active inline — frozen top-level
                    # variable was computed at ha_start, before timers had settled.
                    value_template: >-
                      {{ auto_tag_fan != '' and is_state(auto_tag_fan,'on')
                         and fan_currently_on
                         and not (fan_runon_t != '' and is_state(fan_runon_t, 'active')) }}
                sequence:
                  - choose:
                      - conditions:
                          - condition: template
                            value_template: "{{ fan_entity != '' }}"
                        sequence:
                          - action: fan.turn_off
                            target:
                              entity_id: "{{ fan_entity }}"
                      - conditions:
                          - condition: template
                            value_template: "{{ (fan_entity == '') and (fan_switches | length > 0) }}"
                        sequence:
                          - action: switch.turn_off
                            target:
                              entity_id: !input fan_switches
                  - action: input_boolean.turn_off
                    target:
                      entity_id: "{{ auto_tag_fan }}"
