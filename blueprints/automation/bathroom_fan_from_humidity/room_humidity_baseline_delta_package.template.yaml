# Humidity baseline + delta (package template)
# Tokens:
#   - room_slug            -> replaced with generated slug (e.g. master_bathroom)
#   - Room Friendly Name   -> replaced with friendly room name (e.g. Master Bathroom)
#   - __HUMIDITY_SENSOR__  -> replaced with humidity sensor entity_id (e.g. sensor.master_bath_humidity)
#   - __FAN_ENTITY__       -> replaced with fan entity_id (fan.* or switch.*)

# Optional blocks:
#   # --- BEGIN tuning_helpers --- / # --- END tuning_helpers ---

# --- BEGIN tuning_helpers ---
input_boolean:
  room_slug_humidity_freeze_while_fan_on:
    name: "Room Friendly Name Freeze baseline while fan on"
    icon: mdi:snowflake

input_number:
  room_slug_humidity_big_rise_freeze:
    name: "Room Friendly Name Big rise freeze"
    min: 0.0
    max: 20.0
    step: 0.1
    unit_of_measurement: "%"

  room_slug_humidity_settle_band:
    name: "Room Friendly Name Small-rise band"
    min: 0.0
    max: 10.0
    step: 0.1
    unit_of_measurement: "%"

  room_slug_humidity_alpha_up:
    name: "Room Friendly Name Baseline follow-up rate"
    min: 0.0
    max: 1.0
    step: 0.01

  room_slug_humidity_alpha_down:
    name: "Room Friendly Name Baseline follow-down rate"
    min: 0.0
    max: 1.0
    step: 0.01

  room_slug_humidity_clamp_min:
    name: "Room Friendly Name Clamp min"
    min: 0
    max: 100
    step: 1
    unit_of_measurement: "%"

  room_slug_humidity_clamp_max:
    name: "Room Friendly Name Clamp max"
    min: 0
    max: 100
    step: 1
    unit_of_measurement: "%"

  room_slug_humidity_delta_floor:
    name: "Room Friendly Name Delta floor"
    min: 0
    max: 50
    step: 0.1
    unit_of_measurement: "%"
# --- END tuning_helpers ---

template:
  # Adaptive humidity baseline (trigger-based template sensor)
  - trigger:
      - platform: state
        entity_id: __HUMIDITY_SENSOR__
      - platform: time_pattern
        minutes: "/5"
    sensor:
      - name: "Room Friendly Name Humidity Baseline"
        unique_id: room_slug_humidity_baseline
        unit_of_measurement: "%"
        device_class: humidity
        state_class: measurement
        variables:
          h: __HUMIDITY_SENSOR__
          fan: __FAN_ENTITY__
        availability: >
          {{ is_number(states(h)) }}
        state: >-
          {% set cur_raw = states(h) | float(none) %}
          {% if cur_raw is none %}
            {{ this.state | default('unknown') }}
          {% else %}
            {# pull tuning from helpers with safe defaults #}
            {% set freeze_state = states('input_boolean.room_slug_humidity_freeze_while_fan_on') %}
            {% set freeze_fan = (freeze_state == 'on') if freeze_state not in ['unknown','unavailable','none',''] else true %}

            {% set big_rise = states('input_number.room_slug_humidity_big_rise_freeze') | float(3.0) %}
            {% set band = states('input_number.room_slug_humidity_settle_band') | float(1.0) %}
            {% set a_up = states('input_number.room_slug_humidity_alpha_up') | float(0.05) %}
            {% set a_dn = states('input_number.room_slug_humidity_alpha_down') | float(0.25) %}
            {% set cmin = states('input_number.room_slug_humidity_clamp_min') | float(0) %}
            {% set cmax = states('input_number.room_slug_humidity_clamp_max') | float(100) %}

            {% set cur = [cmax, [cmin, cur_raw]|max] | min %}
            {% set prev = this.state | float(cur) %}
            {% set fan_on = (freeze_fan and is_state(fan, 'on')) %}
            {% set rise = cur - prev %}

            {% if fan_on %}
              {% set base = prev %}
            {% else %}
              {% if rise >= big_rise %}
                {% set base = prev %}
              {% elif cur <= prev %}
                {% set base = (prev*(1-a_dn) + cur*a_dn) %}
              {% elif (cur - prev) < band %}
                {% set base = (prev*(1-a_up) + cur*a_up) %}
              {% else %}
                {% set base = prev %}
              {% endif %}
            {% endif %}

            {{ base | round(1) }}
          {% endif %}

  # Delta from baseline (plain template sensor)
  - sensor:
      - name: "Room Friendly Name Humidity Delta"
        unique_id: room_slug_humidity_delta
        unit_of_measurement: "%"
        state_class: measurement
        variables:
          h: __HUMIDITY_SENSOR__
          b: sensor.room_slug_humidity_baseline
        availability: >
          {{ is_number(states(h)) and is_number(states(b)) }}
        state: >-
          {% set floor = states('input_number.room_slug_humidity_delta_floor') | float(0) %}
          {% set cur = states(h) | float(0) %}
          {% set base = states(b) | float(cur) %}
          {{ [ (cur - base), floor ] | max | round(1) }}
