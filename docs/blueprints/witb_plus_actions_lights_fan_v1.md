# WITB+ Actions - Lights + Fan

## Scope

- Source blueprint: `blueprints/automation/witb_plus_actions_lights_fan/v1/witb_plus_actions_lights_fan.yaml`
- Blueprint name: `WITB+ Actions - Lights + Fan v2.1.1`
- Home Assistant minimum: `2026.2.0`
- Domain: `automation`

This blueprint handles room actions (lights and fan) using occupancy from WITB+:
- Input occupancy sensor: usually `binary_sensor.<slug>_occupied_effective`
- Safe OFF behavior via optional auto-tag booleans
- Optional cooldown, run-on, humidity hold, and startup cleanup

## Pairing Model

Use this blueprint with:
- Occupancy logic from `blueprints/automation/witb_plus/v4/witb_plus.yaml`
- Helpers generated by:
  - `blueprints/automation/witb_plus_actions_lights_fan/v1/generate_witb_plus_actions_packages_templated.py`

Generate helper packages:

```bash
python blueprints/automation/witb_plus_actions_lights_fan/v1/generate_witb_plus_actions_packages_templated.py \
  --rooms "Office" "Master Bathroom Toilet" \
  --template blueprints/automation/witb_plus_actions_lights_fan/v1/room_witb_actions_package.template.yaml \
  --out blueprints/automation/witb_plus_actions_lights_fan/v1/packages
```

## Safety Rules

- `automation_override` ON blocks all ON/OFF actions.
- `force_occupied` or `manual_occupied` ON blocks vacancy OFF actions.
- If `auto_tag_lights` is set, lights turn OFF only when that tag is ON.
- If `auto_tag_fan` is set, fan turns OFF only when that tag is ON.
- Humidity hold applies only when `auto_tag_fan` is set and ON.

## Input Reference

### Occupancy Source

- `occupied_effective`: occupancy binary sensor source.

### Lights

- `lights` (default: empty): target lights.
- `auto_tag_lights` (default: empty): safety tag helper.
- `turn_on_only_if_dark` (default: `true`): sun-based dark gate when lux is not used.
- `illuminance_entity` (default: empty): optional lux sensor.
- `use_illuminance_gate` (default: `true`): use lux-based gate if lux sensor exists.
- `illuminance_threshold` (default: `30`): static lux threshold.
- `illuminance_threshold_helper` (default: empty): optional runtime lux threshold override.
- `use_night_profile` (default: `true`): enable night brightness profile.
- `night_start` (default: `00:00:00`): night window start.
- `night_end` (default: `06:00:00`): night window end.
- `brightness_day_pct` (default: `100`): day brightness.
- `brightness_night_pct` (default: `20`): night brightness.
- `transition_on` (default: `1`): light ON transition seconds.
- `transition_off` (default: `2`): light OFF transition seconds.
- `skip_on_if_any_light_on` (default: `true`): avoid resetting already-on lights.
- `lights_off_delay` (default: `00:02:00`): vacancy delay before light OFF.

### Fan Core

- `fan_entity` (default: empty): `fan.*` target with speed/preset support.
- `fan_switches` (default: empty): `switch.*` targets (ON/OFF only), ignored if `fan_entity` set.
- `auto_tag_fan` (default: empty): fan safety tag helper.
- `fan_turn_on_on_occupy` (default: `true`): fan ON on occupancy.
- `fan_on_delay` (default: `00:00:00`): static fan ON delay.
- `fan_on_delay_seconds_helper` (default: empty): runtime ON delay override.
- `fan_turn_off_on_vacant` (default: `true`): enable vacancy fan OFF behavior.
- `fan_disable_during_night` (default: `false`): suppress fan ON during night window.
- `fan_runon_timer` (default: empty): timer helper for run-on.
- `fan_runon_duration` (default: `00:10:00`): run-on duration.
- `fan_runon_starts_after_lights_off` (default: `true`): start run-on after light-off point.

### Humidity Hold

- `humidity_entity` (default: empty): humidity sensor.
- `humidity_high` (default: `65`): high threshold.
- `humidity_low` (default: `55`): low threshold (hysteresis).
- `humidity_high_helper` (default: empty): runtime high threshold override.
- `humidity_low_helper` (default: empty): runtime low threshold override.
- `humidity_check_interval` (default: `00:02:00`): hold loop re-check interval.
- `humidity_hold_max` (default: `01:00:00`): max hold duration.

### Fan Speed/Preset Profiles

- `fan_use_night_profile` (default: `false`): use night speed/preset profile.
- `fan_percentage_day` (default: `0`): day speed (`0` means do not set percentage).
- `fan_percentage_night` (default: `0`): night speed (`0` means do not set percentage).
- `fan_preset_day` (default: empty): day preset.
- `fan_preset_night` (default: empty): night preset.
- `fan_skip_on_if_already_on` (default: `true`): avoid reapplying ON/speed when already ON.

### Startup Cleanup

- `startup_cleanup` (default: `true`): cleanup stale auto-tagged entities after HA restart.
- `startup_cleanup_delay` (default: `00:00:10`): startup delay before cleanup.

### Overrides

- `automation_override` (default: empty): full actions bypass.
- `force_occupied` (default: empty): block vacancy OFF.
- `manual_occupied` (default: empty): block vacancy OFF.

### Timing and Cooldown

- `on_debounce` (default: `00:00:00`): occupancy ON debounce.
- `cooldown_timer` (default: empty): optional ON action cooldown timer.
- `cooldown_duration` (default: `00:00:30`): cooldown duration.

## Trigger/Action Summary

- Occupied ON trigger runs light/fan ON flow (with debounce and optional cooldown).
- Vacancy off-delay trigger turns lights OFF and optionally starts fan run-on.
- Vacancy start trigger can start run-on immediately (configurable mode).
- Run-on timer finished event turns fan OFF (with optional humidity hold extension).
- HA start trigger performs optional startup cleanup.

## Recommended Setup Order

1. Create occupancy with WITB+ v4 and verify `binary_sensor.<slug>_occupied_effective`.
2. Generate/load actions helpers package for the same slug.
3. Create automation from this blueprint.
4. Bind occupancy sensor, light/fan targets, and helper entities.
5. Tune night window, run-on, lux, humidity, and cooldown settings.
